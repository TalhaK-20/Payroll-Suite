<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payroll Management System</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="icon" type="image/png" href="/images/salary.png">
  <style>
    /* Home Hero Section */
    .hero-section {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 3rem 2rem;
      text-align: center;
      margin-bottom: 3rem;
      border-radius: 15px;
    }

    .hero-section h2 {
      font-size: 2.5rem;
      margin: 0 0 1rem 0;
      font-weight: 700;
    }

    .hero-section p {
      font-size: 1.2rem;
      opacity: 0.95;
      margin: 0 0 2rem 0;
    }

    .hero-actions {
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
    }

    .hero-actions .btn {
      padding: 0.8rem 2rem;
      font-size: 1rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .hero-actions .btn-primary {
      background: white;
      color: #667eea;
    }

    .hero-actions .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }

    .hero-actions .btn-secondary {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 2px solid white;
    }

    .hero-actions .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }

    /* Pay Distribution Box */
    .pay-distribution-box {
      background: linear-gradient(135deg, #f5f7fa 0%, #e9ecf1 100%);
      border: 2px solid #d0d8e8;
      border-radius: 10px;
      padding: 2rem;
      margin: 1rem 0;
    }

    .pay-dist-row {
      display: flex;
      justify-content: space-around;
      align-items: center;
      gap: 2rem;
      margin-bottom: 1rem;
    }

    .pay-dist-item {
      text-align: center;
      flex: 1;
      padding: 1.5rem;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
    }

    .pay-dist-item:hover {
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      transform: translateY(-2px);
    }

    .pay-dist-label {
      display: block;
      font-size: 0.9rem;
      color: #666;
      font-weight: 600;
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .pay-dist-amount {
      font-size: 2rem;
      font-weight: 700;
      color: #667eea;
      margin: 0.5rem 0;
      line-height: 1;
    }

    .pay-dist-hours {
      display: block;
      font-size: 0.85rem;
      color: #999;
      margin-top: 0.5rem;
    }

    .pay-dist-icon {
      font-size: 1.5rem;
      color: #aaa;
      display: flex;
      align-items: center;
    }

    /* Metrics Grid */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 1rem;
      margin-bottom: 3rem;
    }

    .metric-card {
      background: white;
      padding: 1.2rem;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      text-align: center;
    }

    .metric-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    }

    .metric-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
    }

    .metric-card.success::before {
      background: linear-gradient(90deg, #27ae60 0%, #2ecc71 100%);
    }

    .metric-card.warning::before {
      background: linear-gradient(90deg, #f39c12 0%, #e67e22 100%);
    }

    .metric-card.danger::before {
      background: linear-gradient(90deg, #e74c3c 0%, #c0392b 100%);
    }

    .metric-label {
      font-size: 0.75rem;
      color: #888;
      font-weight: 600;
      margin-bottom: 0.4rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .metric-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: #667eea;
      margin: 0.3rem 0;
    }

    .metric-card.success .metric-value {
      color: #27ae60;
    }

    .metric-card.warning .metric-value {
      color: #f39c12;
    }

    .metric-card.danger .metric-value {
      color: #e74c3c;
    }

    .metric-unit {
      font-size: 0.7rem;
      color: #aaa;
      font-weight: 400;
    }

    /* Quick Actions */
    .quick-actions-section {
      margin: 3rem 0;
    }

    .quick-actions-section h3 {
      font-size: 1.5rem;
      color: #333;
      margin-bottom: 1.5rem;
      font-weight: 700;
    }

    /* Payroll Records Section */
    .payroll-section {
      margin: 3rem 0;
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    }

    .payroll-section h3 {
      font-size: 1.3rem;
      color: #333;
      margin-top: 0;
      margin-bottom: 1.5rem;
      font-weight: 700;
    }

    .payroll-records-container {
      overflow-x: auto;
    }

    .payroll-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    .payroll-table thead {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .payroll-table th {
      padding: 1rem;
      text-align: left;
      font-weight: 600;
    }

    .payroll-table td {
      padding: 0.9rem 1rem;
      border-bottom: 1px solid #eee;
    }

    .payroll-table tbody tr:hover {
      opacity: 0.95;
    }

    .payroll-table tbody tr:nth-child(even) {
      background-color: inherit;
    }

    /* Action Buttons in Payroll Table */
    .action-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.1rem;
      margin: 0 0.3rem;
      padding: 0.3rem 0.5rem;
      transition: transform 0.2s ease;
    }

    .action-btn:hover {
      transform: scale(1.3);
    }

    .action-btn.edit-btn:hover {
      color: #667eea;
    }

    .action-btn.pdf-btn:hover {
      color: #764ba2;
    }

    .action-btn.delete-btn:hover {
      color: #dc3545;
    }

    /* Calendar Section */
    .calendar-section {
      margin: 3rem 0;
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    }

    .calendar-section h3 {
      font-size: 1.3rem;
      color: #333;
      margin-top: 0;
      margin-bottom: 1.5rem;
      font-weight: 700;
    }

    .calendar-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.5rem;
    }

    .calendar-day {
      aspect-ratio: 1;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 0.5rem;
      text-align: center;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .calendar-day:hover {
      border-color: #667eea;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    }

    .calendar-day.has-records {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: #667eea;
      font-weight: 600;
    }

    .calendar-day.today {
      border: 2px solid #f39c12;
      font-weight: bold;
    }

    .calendar-day.other-month {
      color: #ccc;
      background: #f9f9f9;
    }

    .calendar-day-num {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.3rem;
    }

    .calendar-day-count {
      font-size: 0.7rem;
      line-height: 1.2;
    }

    .status-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: capitalize;
    }

    .status-badge.status-pending {
      background-color: #ffebee;
      color: #c62828;
    }

    .status-badge.status-ongoing {
      background-color: #fff3e0;
      color: #e65100;
    }

    .status-badge.status-completed {
      background-color: #e8f5e9;
      color: #2e7d32;
    }

    @media (max-width: 768px) {
      header nav ul {
        gap: 1rem;
        font-size: 0.9rem;
      }

      header .header-brand h1 {
        font-size: 1.4rem;
      }

      .hero-section h2 {
        font-size: 1.8rem;
      }

      .metrics-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="header-brand">
        <img src="/images/salary.png" alt="Payroll Logo" class="logo">
        <h1>üíº Payroll Pro</h1>
      </div>
      <nav>
        <ul>
          <li><a href="/">üè† Home</a></li>
          <li><a href="/guards">üë• Guards</a></li>
          <li><a href="/clients">üè¢ Clients</a></li>
          <li><a href="/monthly-hours">‚è∞ Monthly Hours</a></li>
          <li><a href="/reports">üìä Reports</a></li>
          <li><a href="/roster">Roster</a></li>
          <li><a href="/upload">üì§ Upload</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main>
    <div class="container">
      <!-- Alerts -->
      <div id="alertContainer"></div>

      <!-- Hero Section -->
      <div class="hero-section">
        <h2>Welcome to Payroll Pro ‚ú®</h2>
        <p>Manage guards, track hours, and process payroll with ease</p>
        <div class="hero-actions">
          <button class="btn btn-primary" onclick="openAddForm()">‚ûï Add New Record</button>
          <button class="btn btn-secondary" onclick="document.location.href='/upload'">üì§ Upload Excel</button>
        </div>
      </div>

      <!-- Metrics Grid -->
      <div class="metrics-grid">
        <div class="metric-card">
          <div class="metric-label">Total Guards</div>
          <div class="metric-value" id="totalGuards">0</div>
          <div class="metric-unit">Active Guards</div>
        </div>

        <div class="metric-card success">
          <div class="metric-label">Hours This Month</div>
          <div class="metric-value"><span id="totalHoursValue">0</span>h</div>
          <div class="metric-unit"><span id="totalMinutesValue">0</span> minutes</div>
        </div>

        <div class="metric-card success">
          <div class="metric-label">Hours Paid</div>
          <div class="metric-value"><span id="paidHoursValue">0</span>h</div>
          <div class="metric-unit"><span id="paidMinutesValue">0</span> minutes</div>
        </div>

        <div class="metric-card success">
          <div class="metric-label">Total Hours Added (Today)</div>
          <div class="metric-value"><span id="totalHoursAdded">0</span>h</div>
          <div class="metric-unit"><span id="totalHoursAddedMinutes">0</span> minutes</div>
        </div>

        <div class="metric-card warning">
          <div class="metric-label">Hours Remaining</div>
          <div class="metric-value"><span id="remainingHoursValue">0</span>h</div>
          <div class="metric-unit"><span id="remainingMinutesValue">0</span> minutes</div>
        </div>

        <div class="metric-card warning">
          <div class="metric-label">Pending Payrolls</div>
          <div class="metric-value" id="pendingPayrolls">0</div>
          <div class="metric-unit">To be processed</div>
        </div>

        <!-- <div class="metric-card danger" sty>
          <div class="metric-label">Expiring Alerts</div>
          <div class="metric-value" id="expiringAlerts">0</div>
          <div class="metric-unit">Share codes</div>
        </div> -->
      </div>
      <!-- Recent Payroll Records -->
      <div class="payroll-section">
        <h3>üìã Recent Payroll Records</h3>
        
        <!-- Advanced Filters Section -->
        <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e0e0e0;">
          <h4 style="margin-top: 0; margin-bottom: 15px; color: #333; font-weight: 600;">üîç Filter Records</h4>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <div>
              <label style="display: block; font-size: 0.9rem; font-weight: 500; margin-bottom: 5px; color: #555;">Guard Name</label>
              <input type="text" id="filterGuard" placeholder="Search guard name..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label style="display: block; font-size: 0.9rem; font-weight: 500; margin-bottom: 5px; color: #555;">Insurance Number</label>
              <input type="text" id="filterInsurance" placeholder="Search insurance number..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label style="display: block; font-size: 0.9rem; font-weight: 500; margin-bottom: 5px; color: #555;">Visa Status</label>
              <select id="filterVisa" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="">-- All Statuses --</option>
                <option value="Student">Student</option>
                <option value="Skilled Worker">Skilled Worker</option>
                <option value="PSW">PSW</option>
                <option value="Dependent/Spouse">Dependent/Spouse</option>
                <option value="Permanent Resident">Permanent Resident</option>
                <option value="Settled Status">Settled Status</option>
                <option value="Pre-Settled Status">Pre-Settled Status</option>
                <option value="Refugee/Asylum">Refugee/Asylum</option>
              </select>
            </div>
            <div>
              <label style="display: block; font-size: 0.9rem; font-weight: 500; margin-bottom: 5px; color: #555;">Nationality</label>
              <input type="text" id="filterNationality" placeholder="Search nationality..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label style="display: block; font-size: 0.9rem; font-weight: 500; margin-bottom: 5px; color: #555;">Client Name</label>
              <input type="text" id="filterClient" placeholder="Search client name..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
          </div>
          <div style="margin-top: 15px; display: flex; gap: 10px;">
            <button onclick="applyFiltersIndex()" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">üîé Apply Filters</button>
            <button onclick="resetFiltersIndex()" style="padding: 8px 16px; background: #f0f0f0; color: #333; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-weight: 500;">‚Ü∫ Reset Filters</button>
          </div>
        </div>
        
        <div class="payroll-records-container">
          <table class="payroll-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Guard Name</th>
                <th>Client</th>
                <th>Total Hours</th>
                <th>Hours Spent</th>
                <th>Remaining Hours</th>
                <th>Associated Guard</th>
                <th>Associated Hours</th>
                <th>Total Pay</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="payrollRecordsBody">
              <tr><td colspan="10" style="text-align: center; padding: 2rem;">Loading records...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Payroll Calendar -->
      <div class="calendar-section">
        <h3>üìÖ Payroll by Day</h3>
        <div class="calendar-controls">
          <button onclick="previousCalendarMonth()" class="btn btn-sm">‚óÄ Previous</button>
          <span id="calendarMonthLabel" style="font-weight: bold; margin: 0 1rem;">Current Month</span>
          <button onclick="nextCalendarMonth()" class="btn btn-sm">Next ‚ñ∂</button>
        </div>
        <div class="calendar-grid" id="payrollCalendar">
          <!-- Calendar will be populated by JavaScript -->
        </div>
      </div>
    </div>
  </main>

  <!-- Payroll Status Edit Modal -->
  <div id="statusModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header-professional">
        <h2>Edit Payroll Status</h2>
        <button class="modal-close-btn" onclick="closeStatusModal()">‚úï</button>
      </div>
      
      <div style="padding: 20px;">
        <div id="payrollStatusDisplay" style="margin-bottom: 20px; padding: 15px; background: #f5f5f5; border-radius: 5px;">
          <p style="margin: 5px 0;"><strong>Guard:</strong> <span id="statusGuardName"></span></p>
          <p style="margin: 5px 0;"><strong>Total Hours:</strong> <span id="statusTotalHours"></span></p>
          <p style="margin: 5px 0;"><strong>Hours Spent:</strong> <span id="statusHoursSpent"></span></p>
          <p style="margin: 5px 0;"><strong>Remaining Hours:</strong> <span id="statusRemainingHours"></span></p>
        </div>
        
        <div style="margin-bottom: 20px;">
          <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #333;">Status</label>
          <select id="statusInput" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
            <option value="pending">üî¥ Pending (Not Started)</option>
            <option value="ongoing">üü° Ongoing (In Progress)</option>
            <option value="completed">üü¢ Completed</option>
          </select>
          <small style="display: block; margin-top: 5px; color: #666;">Note: Can only mark as "Completed" when remaining hours = 0</small>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <button onclick="closeStatusModal()" style="padding: 10px; background: #f0f0f0; color: #333; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-weight: 500;">Cancel</button>
          <button onclick="savePayrollStatus()" style="padding: 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">Save Status</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Form Modal -->
  <div id="formModal" class="modal">
    <div class="modal-content modal-professional" style="max-height: 90vh; overflow-y: auto;">
      <div class="modal-header-professional" style="position: sticky; top: 0; background: white; z-index: 100;">
        <div class="modal-title-section">
          <div class="modal-icon">üìã</div>
          <div>
            <h2 id="formModalTitle">Add New Payroll Record</h2>
            <p class="modal-subtitle">Enter complete guard and payment information</p>
          </div>
        </div>
        <button class="modal-close-btn" onclick="closeFormModal()">‚úï</button>
      </div>
      
      <form id="payrollForm">
        <input type="hidden" id="id" name="id">
        
        <!-- SECTION 1: Guard Basic Information -->
        <div class="form-section">
          <h3 class="section-title">üë§ Guard Basic Information</h3>
          <div class="form-row-2col">
            <div class="form-group">
              <label>Guard <span class="required">*</span></label>
              <select id="guardId" name="guardId" required onchange="updateGuardDetailsIndex()">
                <option value="">Select Guard</option>
              </select>
              <small class="field-hint">Select from available guards</small>
            </div>
            <div class="form-group">
              <label>Nationality <span class="required">*</span></label>
              <input type="text" id="nationality" name="nationality" readonly style="background-color: #f5f5f5;">
              <small class="field-hint">Auto-populated from guard selection</small>
            </div>
          </div>
          <div class="form-row-2col">
            <div class="form-group">
              <label>Guard Name (Display)</label>
              <input type="text" id="guardName" name="guardName" readonly style="background-color: #f5f5f5;">
              <small class="field-hint">Auto-populated from selection</small>
            </div>
          <div class="form-row-2col">
            <div class="form-group">
              <label>Insurance Number <span class="required">*</span></label>
              <input type="text" id="insuranceNumber" name="insuranceNumber" placeholder="e.g., AB 123 456 C" required>
              <small class="field-hint">National Insurance: AB 123 456 C</small>
            </div>
            <div class="form-group">
              <label>Site Name</label>
              <input type="text" id="siteName" name="siteName" placeholder="e.g., Arnold Laver Peterborough">
              <small class="field-hint">Work location (optional)</small>
            </div>
          </div>
        </div>

        <!-- SECTION 2: Immigration & Visa Status -->
        <div class="form-section">
          <h3 class="section-title">üõÇ Immigration & Visa Status</h3>
          <div class="form-row-2col">
            <div class="form-group">
              <label>Visa Status <span class="required">*</span></label>
              <select id="visaStatus" name="visaStatus" required onchange="toggleShareCodeFields()">
                <option value="">-- Select Visa Status --</option>
                <option value="Student">Student</option>
                <option value="Skilled Worker">Skilled Worker</option>
                <option value="PSW">PSW (Points-Based System)</option>
                <option value="Dependent/Spouse">Dependent/Spouse</option>
                <option value="Permanent Resident">Permanent Resident</option>
                <option value="Settled Status">Settled Status</option>
                <option value="Pre-Settled Status">Pre-Settled Status</option>
                <option value="Refugee/Asylum">Refugee/Asylum Seeker</option>
              </select>
              <small class="field-hint">Immigration status classification</small>
            </div>
            <div class="form-group">
              <label>
                <input type="checkbox" id="britishPassport" name="britishPassport" onchange="toggleShareCodeFields()">
                British Passport Holder
              </label>
              <small class="field-hint">Check if has British passport</small>
            </div>
          </div>
          
          <!-- Share Code Fields (shown only if NOT British Passport) -->
          <div id="shareCodeContainer" style="display: none;">
            <div class="form-row-2col">
              <div class="form-group">
                <label>Share Code <span class="required">*</span></label>
                <input type="text" id="shareCode" name="shareCode" placeholder="Enter share code">
                <small class="field-hint">Required for non-British passport holders</small>
              </div>
              <div class="form-group">
                <label>Share Code Expiry Date <span class="required">*</span></label>
                <input type="date" id="shareCodeExpiryDate" name="shareCodeExpiryDate">
                <small class="field-hint">When share code expires</small>
              </div>
            </div>
          </div>
        </div>

        <!-- SECTION 3: Client Information -->
        <div class="form-section">
          <h3 class="section-title">üè¢ Client Information</h3>
          <div class="form-row-2col">
            <div class="form-group">
              <label>Client Name <span class="required">*</span></label>
              <select id="clientId" name="clientId" required onchange="updateClientNameIndex()">
                <option value="">Select Client</option>
              </select>
              <small class="field-hint">Select from available clients</small>
            </div>
            <div class="form-group">
              <label>Client Name (Display)</label>
              <input type="text" id="clientName" name="clientName" readonly style="background-color: #f5f5f5;">
              <small class="field-hint">Auto-populated from selection</small>
            </div>
          </div>
        </div>

        <!-- SECTION 4: Working Hours -->
        <div class="form-section">
          <h3 class="section-title">‚è∞ Working Hours</h3>
          <div class="form-row-2col">
            <div class="form-group">
              <label>Total Hours <span class="required">*</span></label>
              <input type="number" id="totalHours" name="totalHours" min="0" placeholder="e.g., 40" required onchange="calculateTotalPay(); updateTotalHoursDisplayIndex();">
              <small class="field-hint">Number of hours worked</small>
            </div>
            <div class="form-group">
              <label>Total Minutes <span class="required">*</span></label>
              <input type="number" id="totalMinutes" name="totalMinutes" min="0" max="59" placeholder="e.g., 30" required onchange="calculateTotalPay();">
              <small class="field-hint">Minutes (0-59)</small>
            </div>
          </div>
          <!-- Dynamic Total Hours Summary -->
          <div class="form-group" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 5px; color: white; margin: 10px 0;">
            <label style="color: white; margin-bottom: 5px; display: block;">üìä Total Hours Summary</label>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
              <div style="padding: 10px; background: rgba(255,255,255,0.2); border-radius: 5px; text-align: center;">
                <small style="display: block; opacity: 0.9;">Primary Guard</small>
                <strong id="primaryHoursSummaryIndex" style="font-size: 1.3em;">0.0</strong> hrs
              </div>
              <div style="padding: 10px; background: rgba(255,255,255,0.2); border-radius: 5px; text-align: center;">
                <small style="display: block; opacity: 0.9;">Associated Guard</small>
                <strong id="associatedHoursSummaryIndex" style="font-size: 1.3em;">0.0</strong> hrs
              </div>
            </div>
            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.3); text-align: center;">
              <small style="display: block; opacity: 0.9;">Total Hours</small>
              <strong id="totalHoursSummaryIndex" style="font-size: 1.5em;">0.0</strong> hrs
            </div>
          </div>
        </div>

        <!-- SECTION 4A: Associated Guard -->
        <div class="form-section">
          <h3 class="section-title">üë• Associated Guard (Optional)</h3>
          <div class="form-row-2col">
            <div class="form-group">
              <label>Associated Guard</label>
              <select id="associatedGuardId" name="associatedGuardId" onchange="updateAssociatedGuardNameIndex(); updateTotalHoursDisplayIndex();">
                <option value="">None</option>
              </select>
              <small class="field-hint">Assign hours to another guard</small>
            </div>
            <div class="form-group">
              <label>Associated Guard Name</label>
              <input type="text" id="associatedGuardName" name="associatedGuardName" readonly style="background-color: #f5f5f5;">
              <small class="field-hint">Auto-populated from selection</small>
            </div>
          </div>
          <div class="form-row-2col">
            <div class="form-group">
              <label>Hours to Transfer (Optional)</label>
              <input type="number" id="associatedGuardHours" name="associatedGuardHours" step="0.5" min="0" onchange="updatePrimaryGuardHoursIndex(); updateTotalHoursDisplayIndex(); updatePayDistribution();">
              <small class="field-hint">Hours for associated guard</small>
            </div>
            <div class="form-group">
              <label>Associated Guard Pay Rate (¬£/hour)</label>
              <input type="number" id="associatedGuardPayRate" name="associatedGuardPayRate" step="0.01" min="0" onchange="updateAssociatedGuardPayIndex(); updatePayDistribution();">
              <small class="field-hint">Hourly rate for associated guard</small>
            </div>
          </div>
          <div class="form-row-2col">
            <div class="form-group">
              <label>Associated Guard Total Pay (¬£)</label>
              <input type="number" id="associatedGuardPay" name="associatedGuardPay" step="0.01" min="0" readonly style="background-color: #f5f5f5;">
              <small class="field-hint">Auto-calculated</small>
            </div>
            <div class="form-group">
              <label>Primary Guard Hours</label>
              <input type="number" id="primaryGuardHours" name="primaryGuardHours" step="0.5" min="0" readonly style="background-color: #f5f5f5;">
              <small class="field-hint">Auto-calculated (Total - Associated)</small>
            </div>
          </div>
        </div>

        <!-- SECTION 5: Rates -->
        <div class="form-section">
          <h3 class="section-title">üí∑ Rates</h3>
          <div class="form-row-2col">
            <div class="form-group">
              <label>Charge Rate <span class="currency">¬£/hour</span> <span class="required">*</span></label>
              <input type="number" id="chargeRate" name="chargeRate" step="0.01" min="0" placeholder="e.g., 18.75" required>
              <small class="field-hint">What client pays per hour</small>
            </div>
            <div class="form-group">
              <label>Pay Rate <span class="currency">¬£/hour</span> <span class="required">*</span></label>
              <input type="number" id="payRate" name="payRate" step="0.01" min="0" placeholder="e.g., 12.50" required onchange="calculateTotalPay()">
              <small class="field-hint">What guard is paid per hour</small>
            </div>
          </div>
          <div class="form-group">
            <p style="background: #f0f4ff; padding: 10px; border-radius: 5px; margin: 10px 0;">
              <strong>Calculated Total Pay:</strong> <span id="totalPayDisplay">¬£0.00</span>
            </p>
          </div>
        </div>

        <!-- SECTION 5.5: Pay Distribution -->
        <div class="form-section">
          <h3 class="section-title">üí∞ Pay Distribution</h3>
          <div class="pay-distribution-box">
            <div class="pay-dist-row">
              <div class="pay-dist-item">
                <label class="pay-dist-label">Primary Guard</label>
                <div class="pay-dist-amount" id="primaryGuardPayDisplay">¬£0.00</div>
                <span class="pay-dist-hours" id="primaryGuardHoursDisplay">0h</span>
              </div>
              <div class="pay-dist-icon">‚ÜîÔ∏è</div>
              <div class="pay-dist-item">
                <label class="pay-dist-label">Associated Guard</label>
                <div class="pay-dist-amount" id="associatedGuardPayDisplay">¬£0.00</div>
                <span class="pay-dist-hours" id="associatedGuardHoursDisplay">0h</span>
              </div>
            </div>
            <div style="text-align: center; margin-top: 1rem; padding: 1rem; background: #fffbf0; border-radius: 5px;">
              <strong>Total Pay:</strong> <span id="totalPaySummary">¬£0.00</span>
            </div>
          </div>
        </div>

        <!-- SECTION 6: Bank Accounts (Multiple) -->
        <div class="form-section">
          <h3 class="section-title">üè¶ Bank Account(s)</h3>
          <p style="color: #666; margin-bottom: 15px;">Add one or more bank accounts for payment distribution</p>
          
          <div id="bankAccountsContainer">
            <!-- Bank accounts will be added here dynamically -->
          </div>
          
          <button type="button" class="btn btn-info" onclick="addBankAccount()">
            ‚ûï Add Another Bank Account
          </button>
        </div>

        <!-- SECTION 7: Legacy Payment Amounts (for backward compatibility) -->
        <div class="form-section">
          <h3 class="section-title">üí∑ Legacy Payment Amounts</h3>
          <p style="color: #999; margin-bottom: 15px;">These fields are for backward compatibility. Use bank account distribution above.</p>
          <div class="form-row-3col">
            <div class="form-group">
              <label>Pay 1 <span class="currency">¬£</span></label>
              <input type="number" id="pay1" name="pay1" step="0.01" min="0" placeholder="e.g., 500">
              <small class="field-hint">Payroll 01</small>
            </div>
            <div class="form-group">
              <label>Pay 2 <span class="currency">¬£</span></label>
              <input type="number" id="pay2" name="pay2" step="0.01" min="0" placeholder="e.g., 550">
              <small class="field-hint">Payroll 02</small>
            </div>
            <div class="form-group">
              <label>Pay 3 <span class="currency">¬£</span></label>
              <input type="number" id="pay3" name="pay3" step="0.01" min="0" placeholder="e.g., 600">
              <small class="field-hint">Payroll 03</small>
            </div>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions-professional">
          <button type="button" class="btn btn-secondary btn-large" onclick="closeFormModal()">Cancel</button>
          <button type="submit" class="btn btn-primary btn-large">üíæ Save Record</button>
        </div>
      </form>
    </div>
  </div>

  <script src="/js/main.js"></script>
  <script src="/js/form-handler.js"></script>
  <script>
    let guardsDataIndex = [];
    let clientsDataIndex = [];
    let bankAccountsDataIndex = [];

    // Load data when modal is opened
    document.addEventListener('DOMContentLoaded', () => {
      // Preload dropdown data
      loadGuardsDropdownIndex();
      loadClientsDropdownIndex();
      loadBankAccountsDropdownIndex();
      
      // Load initial data
      loadPayrollRecords();
      loadMetrics();
      
      // Auto-refresh metrics every 10 seconds
      setInterval(loadMetrics, 10000);
      // Auto-refresh payroll records every 15 seconds
      setInterval(loadPayrollRecords, 15000);
      
      // Hook to modal open for re-loading
      const formModal = document.getElementById('formModal');
      if (formModal) {
        const observer = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            if (mutation.attributeName === 'class' && formModal.classList.contains('active')) {
              // Reload dropdown data when modal opens
              setTimeout(() => {
                loadGuardsDropdownIndex();
                loadClientsDropdownIndex();
                loadBankAccountsDropdownIndex();
              }, 100);
            }
          });
        });
        observer.observe(formModal, { attributes: true });
      }
    });

    async function loadGuardsDropdownIndex() {
      try {
        const response = await fetch('/api/guards');
        const result = await response.json();
        if (result.success) {
          guardsDataIndex = result.data;
          const dropdown = document.getElementById('guardId');
          if (dropdown) {
            dropdown.innerHTML = '<option value="">Select Guard</option>' +
              result.data.map(guard => `
                <option value="${guard._id}" data-guard-name="${guard.guardName}" data-nationality="${guard.nationality}">${guard.guardName}</option>
              `).join('');
            loadAssociatedGuardsDropdownIndex();
          }
        }
      } catch (error) {
        console.error('Error loading guards:', error);
      }
    }

    async function loadClientsDropdownIndex() {
      try {
        const response = await fetch('/api/clients');
        const result = await response.json();
        if (result.success) {
          clientsDataIndex = result.data;
          const dropdown = document.getElementById('clientId');
          if (dropdown) {
            dropdown.innerHTML = '<option value="">Select Client</option>' +
              result.data.map(client => `
                <option value="${client._id}" data-client-name="${client.name}">${client.name}</option>
              `).join('');
          }
        }
      } catch (error) {
        console.error('Error loading clients:', error);
      }
    }

    async function loadBankAccountsDropdownIndex() {
      try {
        const response = await fetch('/api/bank-accounts');
        const result = await response.json();
        if (result.success) {
          bankAccountsDataIndex = result.data;
        }
      } catch (error) {
        console.error('Error loading bank accounts:', error);
      }
    }

    function loadAssociatedGuardsDropdownIndex() {
      const dropdown = document.getElementById('associatedGuardId');
      const currentGuardId = document.getElementById('guardId').value;
      if (dropdown && guardsDataIndex.length > 0) {
        dropdown.innerHTML = '<option value="">None</option>' +
          guardsDataIndex
            .filter(guard => guard._id !== currentGuardId)
            .map(guard => `
              <option value="${guard._id}" data-guard-name="${guard.guardName}">${guard.guardName}</option>
            `).join('');
      }
    }

    function updateGuardDetailsIndex() {
      const guardId = document.getElementById('guardId').value;
      const selected = document.querySelector(`#guardId option[value="${guardId}"]`);
      if (selected) {
        document.getElementById('guardName').value = selected.dataset.guardName;
        document.getElementById('nationality').value = selected.dataset.nationality;
        document.getElementById('associatedGuardId').value = '';
        document.getElementById('associatedGuardName').value = '';
        document.getElementById('associatedGuardHours').value = '';
        document.getElementById('primaryGuardHours').value = '';
        loadAssociatedGuardsDropdownIndex();
      } else {
        document.getElementById('guardName').value = '';
        document.getElementById('nationality').value = '';
      }
    }

    function updateClientNameIndex() {
      const clientId = document.getElementById('clientId').value;
      const selected = document.querySelector(`#clientId option[value="${clientId}"]`);
      if (selected) {
        document.getElementById('clientName').value = selected.dataset.clientName;
      } else {
        document.getElementById('clientName').value = '';
      }
    }

    function updateAssociatedGuardNameIndex() {
      const associatedId = document.getElementById('associatedGuardId').value;
      const selected = document.querySelector(`#associatedGuardId option[value="${associatedId}"]`);
      if (selected) {
        document.getElementById('associatedGuardName').value = selected.dataset.guardName;
      } else {
        document.getElementById('associatedGuardName').value = '';
      }
    }

    function updatePrimaryGuardHoursIndex() {
      const totalHours = parseFloat(document.getElementById('totalHours').value) || 0;
      const associatedHours = parseFloat(document.getElementById('associatedGuardHours').value) || 0;
      const primaryHours = totalHours - associatedHours;
      document.getElementById('primaryGuardHours').value = primaryHours > 0 ? primaryHours.toFixed(2) : 0;
      updateAssociatedGuardPayIndex();
    }

    function updateAssociatedGuardPayIndex() {
      const associatedHours = parseFloat(document.getElementById('associatedGuardHours').value) || 0;
      const associatedPayRate = parseFloat(document.getElementById('associatedGuardPayRate').value) || 0;
      const totalPay = associatedHours * associatedPayRate;
      document.getElementById('associatedGuardPay').value = totalPay.toFixed(2);
    }

    function updateTotalHoursDisplayIndex() {
      const totalHours = parseFloat(document.getElementById('totalHours').value) || 0;
      const associatedHours = parseFloat(document.getElementById('associatedGuardHours').value) || 0;
      const primaryHours = Math.max(0, totalHours - associatedHours);
      
      document.getElementById('totalHoursSummaryIndex').textContent = totalHours.toFixed(1);
      document.getElementById('primaryHoursSummaryIndex').textContent = primaryHours.toFixed(1);
      document.getElementById('associatedHoursSummaryIndex').textContent = associatedHours.toFixed(1);
    }

    // ============ PAYROLL RECORDS AND CALENDAR ============

    let currentCalendarMonth = new Date();

    function loadPayrollRecords() {
      fetch('/api/payroll')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const records = data.data.slice(0, 10); // Show last 10 records
            const tbody = document.getElementById('payrollRecordsBody');
            
            if (records.length === 0) {
              tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 2rem; color: #999;">No payroll records found</td></tr>';
              return;
            }

            tbody.innerHTML = records.map(record => {
              const date = new Date(record.createdAt).toLocaleDateString();
              const associatedGuardName = record.hoursDistribution?.associatedGuardId?.guardName || '-';
              const associatedGuardHours = record.hoursDistribution?.associatedGuardHours || 0;
              const primaryGuardHours = record.hoursDistribution?.primaryGuardHours || 0;
              const totalHoursDecimal = record.totalHours + (record.totalMinutes / 60);
              const hoursSpent = primaryGuardHours + associatedGuardHours;
              const remainingHours = totalHoursDecimal - hoursSpent;
              const totalPay = (totalHoursDecimal * (record.payRate || 0)).toFixed(2);
              const status = record.status || 'pending';
              
              // Color coding based on status
              let statusColor, statusText, rowBackgroundColor;
              if (status === 'completed') {
                statusColor = '#28a745';
                statusText = '‚úì Completed';
                rowBackgroundColor = '#e8f5e9';
              } else if (status === 'ongoing') {
                statusColor = '#ffc107';
                statusText = '‚ü≥ Ongoing';
                rowBackgroundColor = '#fff9c4';
              } else {
                statusColor = '#dc3545';
                statusText = '‚äò Pending';
                rowBackgroundColor = '#ffebee';
              }
              
              return `
                <tr style="background-color: ${rowBackgroundColor};">
                  <td>${date}</td>
                  <td><strong>${record.guardName || '-'}</strong></td>
                  <td>${record.clientName || '-'}</td>
                  <td>${totalHoursDecimal.toFixed(2)}h</td>
                  <td>${hoursSpent.toFixed(2)}h</td>
                  <td>${remainingHours.toFixed(2)}h</td>
                  <td>${associatedGuardName}</td>
                  <td>¬£${totalPay}</td>
                  <td><span style="background: ${statusColor}; color: white; padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">${statusText}</span></td>
                  <td>
                    <button class="action-btn edit-btn" onclick="editPayroll('${record._id}')" title="Edit">‚úèÔ∏è</button>
                    <button class="action-btn pdf-btn" onclick="downloadPayrollPDF('${record._id}')" title="Download PDF">üìÑ</button>
                    <button class="action-btn delete-btn" onclick="deletePayroll('${record._id}')" title="Delete">üóëÔ∏è</button>
                  </td>
                </tr>
              `;
            }).join('');
          }
        })
        .catch(error => {
          console.error('Error loading payroll records:', error);
          const tbody = document.getElementById('payrollRecordsBody');
          tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 2rem; color: #999;">Error loading records</td></tr>';
        });
    }

    function renderPayrollCalendar() {
      fetch('/api/payroll')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const records = data.data;
            const year = currentCalendarMonth.getFullYear();
            const month = currentCalendarMonth.getMonth();

            // Count records by date
            const recordsByDate = {};
            records.forEach(record => {
              const recordDate = new Date(record.createdAt);
              if (recordDate.getFullYear() === year && recordDate.getMonth() === month) {
                const day = recordDate.getDate();
                recordsByDate[day] = (recordsByDate[day] || 0) + 1;
              }
            });

            // Render calendar
            const monthLabel = currentCalendarMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            document.getElementById('calendarMonthLabel').textContent = monthLabel;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();

            let html = '';
            const today = new Date();
            const todayDate = today.getDate();
            const isThisMonth = today.getFullYear() === year && today.getMonth() === month;

            // Empty cells for days before month starts
            for (let i = 0; i < startingDayOfWeek; i++) {
              html += '<div class="calendar-day other-month"></div>';
            }

            // Days of month
            for (let day = 1; day <= daysInMonth; day++) {
              const hasRecords = recordsByDate[day] || 0;
              const isTodayClass = isThisMonth && day === todayDate ? 'today' : '';
              const hasRecordsClass = hasRecords > 0 ? 'has-records' : '';
              
              html += `
                <div class="calendar-day ${isTodayClass} ${hasRecordsClass}">
                  <div class="calendar-day-num">${day}</div>
                  ${hasRecords > 0 ? `<div class="calendar-day-count">${hasRecords} record${hasRecords > 1 ? 's' : ''}</div>` : ''}
                </div>
              `;
            }

            document.getElementById('payrollCalendar').innerHTML = html;
          }
        })
        .catch(error => console.error('Error rendering calendar:', error));
    }

    function previousCalendarMonth() {
      currentCalendarMonth = new Date(currentCalendarMonth.getFullYear(), currentCalendarMonth.getMonth() - 1, 1);
      renderPayrollCalendar();
    }

    function nextCalendarMonth() {
      currentCalendarMonth = new Date(currentCalendarMonth.getFullYear(), currentCalendarMonth.getMonth() + 1, 1);
      renderPayrollCalendar();
    }

    // Load data on page load
    function loadMetrics() {
      // Load total guards
      fetch('/api/guards')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const activeGuards = data.data.filter(g => g.isActive !== false).length;
            document.getElementById('totalGuards').textContent = activeGuards || 0;
          }
        })
        .catch(error => console.error('Error loading guards:', error));

      // Load payroll metrics
      fetch('/api/payroll')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const records = data.data;
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();

            let totalHours = 0;
            let totalMinutes = 0;
            let hoursSpent = 0;
            let todayHours = 0;
            let todayMinutes = 0;
            let pendingCount = 0;
            let expiringAlerts = 0;

            records.forEach(record => {
              const recordDate = new Date(record.createdAt);
              const recordTotalHours = record.totalHours || 0;
              const recordTotalMinutes = record.totalMinutes || 0;
              
              // Count this month's total hours allocated
              if (recordDate.getMonth() === currentMonth && recordDate.getFullYear() === currentYear) {
                totalHours += recordTotalHours;
                totalMinutes += recordTotalMinutes;
                
                // Count hours actually spent (distributed)
                if (record.hoursDistribution) {
                  hoursSpent += (record.hoursDistribution.primaryGuardHours || 0);
                  hoursSpent += (record.hoursDistribution.associatedGuardHours || 0);
                }
              }

              // Count today's records
              if (recordDate.toDateString() === today.toDateString()) {
                todayHours += recordTotalHours;
                todayMinutes += recordTotalMinutes;
              }

              // Count pending payrolls
              if (record.status === 'pending') {
                pendingCount++;
              }

              // Count expiring share codes
              if (record.shareCodeExpiryDate) {
                const expiryDate = new Date(record.shareCodeExpiryDate);
                const daysUntilExpiry = Math.floor((expiryDate - today) / (1000 * 60 * 60 * 24));
                if (daysUntilExpiry >= 0 && daysUntilExpiry <= 30) {
                  expiringAlerts++;
                }
              }
            });

            // Convert total minutes to hours
            totalHours += Math.floor(totalMinutes / 60);
            totalMinutes = totalMinutes % 60;

            todayHours += Math.floor(todayMinutes / 60);
            todayMinutes = todayMinutes % 60;

            // Update metric boxes
            document.getElementById('totalHoursValue').textContent = totalHours;
            document.getElementById('totalMinutesValue').textContent = totalMinutes;
            document.getElementById('paidHoursValue').textContent = Math.floor(hoursSpent);
            document.getElementById('paidMinutesValue').textContent = Math.floor((hoursSpent % 1) * 60);
            document.getElementById('totalHoursAdded').textContent = todayHours;
            document.getElementById('totalHoursAddedMinutes').textContent = todayMinutes;
            
            const totalHoursDecimal = totalHours + (totalMinutes / 60);
            const remainingHours = totalHoursDecimal - hoursSpent;
            document.getElementById('remainingHoursValue').textContent = Math.floor(remainingHours);
            document.getElementById('remainingMinutesValue').textContent = Math.floor((remainingHours % 1) * 60);
            
            document.getElementById('pendingPayrolls').textContent = pendingCount;
            document.getElementById('expiringAlerts').textContent = expiringAlerts;
          }
        })
        .catch(error => console.error('Error loading payroll metrics:', error));
    }

    function editPayroll(payrollId) {
      // Fetch the payroll record
      fetch(`/api/payroll/${payrollId}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const record = data.data;
            
            // Populate form with record data
            document.getElementById('id').value = record._id;
            document.getElementById('guardId').value = record.guardId || '';
            document.getElementById('guardName').value = record.guardName || '';
            document.getElementById('nationality').value = record.nationality || '';
            document.getElementById('insuranceNumber').value = record.insuranceNumber || '';
            document.getElementById('visaStatus').value = record.visaStatus || '';
            document.getElementById('siteName').value = record.siteName || '';
            document.getElementById('clientId').value = record.clientId || '';
            document.getElementById('clientName').value = record.clientName || '';
            document.getElementById('britishPassport').checked = record.britishPassport || false;
            document.getElementById('shareCode').value = record.shareCode || '';
            document.getElementById('shareCodeExpiryDate').value = record.shareCodeExpiryDate ? record.shareCodeExpiryDate.split('T')[0] : '';
            
            // Toggle share code fields visibility based on british passport setting
            setTimeout(() => {
              toggleShareCodeFields();
            }, 100);
            document.getElementById('totalHours').value = record.totalHours || 0;
            document.getElementById('totalMinutes').value = record.totalMinutes || 0;
            document.getElementById('chargeRate').value = record.chargeRate || 0;
            document.getElementById('payRate').value = record.payRate || 0;
            document.getElementById('pay1').value = record.pay1 || 0;
            document.getElementById('pay2').value = record.pay2 || 0;
            document.getElementById('pay3').value = record.pay3 || 0;
            
            // Associated guard details - properly populate from dropdown
            if (record.hoursDistribution) {
              document.getElementById('associatedGuardId').value = record.hoursDistribution.associatedGuardId || '';
              document.getElementById('associatedGuardName').value = record.hoursDistribution.associatedGuardName || '';
              document.getElementById('associatedGuardHours').value = record.hoursDistribution.associatedGuardHours || 0;
              document.getElementById('primaryGuardHours').value = record.hoursDistribution.primaryGuardHours || 0;
              // Trigger dropdown update to ensure name is synced
              updateAssociatedGuardNameIndex();
            }
            
            // Populate bank accounts
            const bankAccountsContainer = document.getElementById('bankAccountsContainer');
            bankAccountsContainer.innerHTML = ''; // Clear existing accounts
            
            if (record.bankAccounts && record.bankAccounts.length > 0) {
              // Populate from bankAccounts array
              record.bankAccounts.forEach((account, index) => {
                // Create the account card HTML
                const accountHTML = `
                  <div class="bank-account-card" id="bankAccount-${index}" style="border: 1px solid #ddd; padding: 15px; border-radius: 5px; margin-bottom: 15px; background: #f9f9f9;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                      <h4 style="margin: 0;">Bank Account ${index + 1}</h4>
                      ${index > 0 ? `
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeBankAccount(${index})">
                          üóëÔ∏è Remove
                        </button>
                      ` : ''}
                    </div>
                    
                    <div class="form-row-2col">
                      <div class="form-group">
                        <label>Account Holder Name</label>
                        <input type="text" 
                          id="accountHolderName-${index}" 
                          name="bankAccounts[${index}][accountHolderName]" 
                          placeholder="e.g., John Smith" 
                          value="${account.accountHolderName || ''}">
                        <small class="field-hint">Name on bank account</small>
                      </div>
                      <div class="form-group">
                        <label>Bank Name</label>
                        <input type="text" 
                          id="bankName-${index}" 
                          name="bankAccounts[${index}][bankName]" 
                          placeholder="e.g., Barclays, HSBC, Lloyds"
                          value="${account.bankName || ''}">
                        <small class="field-hint">Bank name</small>
                      </div>
                    </div>
                    
                    <div class="form-row-2col">
                      <div class="form-group">
                        <label>Sort Code</label>
                        <input type="text" 
                          id="sortCode-${index}" 
                          name="bankAccounts[${index}][sortCode]" 
                          placeholder="e.g., 12-34-56"
                          value="${account.sortCode || ''}">
                        <small class="field-hint">Format: XX-XX-XX</small>
                      </div>
                      <div class="form-group">
                        <label>Account Number</label>
                        <input type="text" 
                          id="accountNumber-${index}" 
                          name="bankAccounts[${index}][accountNumber]" 
                          placeholder="e.g., 12345678"
                          value="${account.accountNumber || ''}">
                        <small class="field-hint">8-10 digit account number</small>
                      </div>
                    </div>
                    
                    <div class="form-row-2col">
                      <div class="form-group">
                        <label>
                          <input type="checkbox" 
                            id="isPrimary-${index}" 
                            name="bankAccounts[${index}][isPrimary]"
                            ${account.isPrimary ? 'checked' : ''}>
                          Primary Account
                        </label>
                        <small class="field-hint">Main payment account</small>
                      </div>
                      <div class="form-group">
                        <label>
                          <input type="checkbox" 
                            id="active-${index}" 
                            name="bankAccounts[${index}][active]"
                            ${account.active ? 'checked' : ''}>
                          Active
                        </label>
                        <small class="field-hint">Account is active</small>
                      </div>
                    </div>
                  </div>
                `;
                bankAccountsContainer.insertAdjacentHTML('beforeend', accountHTML);
              });
            } else if (record.accountHolderName || record.sortCode || record.accountNo) {
              // Fall back to legacy flat fields if no bankAccounts array
              const accountHTML = `
                <div class="bank-account-card" id="bankAccount-0" style="border: 1px solid #ddd; padding: 15px; border-radius: 5px; margin-bottom: 15px; background: #f9f9f9;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h4 style="margin: 0;">Bank Account 1</h4>
                  </div>
                  
                  <div class="form-row-2col">
                    <div class="form-group">
                      <label>Account Holder Name</label>
                      <input type="text" 
                        id="accountHolderName-0" 
                        name="bankAccounts[0][accountHolderName]" 
                        placeholder="e.g., John Smith" 
                        value="${record.accountHolderName || ''}">
                      <small class="field-hint">Name on bank account</small>
                    </div>
                    <div class="form-group">
                      <label>Bank Name</label>
                      <input type="text" 
                        id="bankName-0" 
                        name="bankAccounts[0][bankName]" 
                        placeholder="e.g., Barclays, HSBC, Lloyds">
                      <small class="field-hint">Bank name</small>
                    </div>
                  </div>
                  
                  <div class="form-row-2col">
                    <div class="form-group">
                      <label>Sort Code</label>
                      <input type="text" 
                        id="sortCode-0" 
                        name="bankAccounts[0][sortCode]" 
                        placeholder="e.g., 12-34-56"
                        value="${record.sortCode || ''}">
                      <small class="field-hint">Format: XX-XX-XX</small>
                    </div>
                    <div class="form-group">
                      <label>Account Number</label>
                      <input type="text" 
                        id="accountNumber-0" 
                        name="bankAccounts[0][accountNumber]" 
                        placeholder="e.g., 12345678"
                        value="${record.accountNo || ''}">
                      <small class="field-hint">8-10 digit account number</small>
                    </div>
                  </div>
                  
                  <div class="form-row-2col">
                    <div class="form-group">
                      <label>
                        <input type="checkbox" 
                          id="isPrimary-0" 
                          name="bankAccounts[0][isPrimary]"
                          checked>
                        Primary Account
                      </label>
                      <small class="field-hint">Main payment account</small>
                    </div>
                    <div class="form-group">
                      <label>
                        <input type="checkbox" 
                          id="active-0" 
                          name="bankAccounts[0][active]"
                          checked>
                        Active
                      </label>
                      <small class="field-hint">Account is active</small>
                    </div>
                  </div>
                </div>
              `;
              bankAccountsContainer.insertAdjacentHTML('beforeend', accountHTML);
            } else {
              // No bank account data, add empty card
              if (typeof addBankAccount === 'function') {
                addBankAccount();
              }
            }
            
            // Update title
            document.getElementById('formModalTitle').textContent = 'Edit Payroll Record';
            
            // Recalculate and display all pay distribution values
            setTimeout(() => {
              calculateTotalPay();
              updatePayDistribution();
              updateTotalHoursDisplayIndex();
              updatePrimaryGuardHoursIndex();
            }, 100);
            
            // Open modal
            openFormModal();
          }
        })
        .catch(error => console.error('Error loading payroll record:', error));
    }

    function deletePayroll(payrollId) {
      if (confirm('Are you sure you want to delete this payroll record? This action cannot be undone.')) {
        fetch(`/api/payroll/${payrollId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Payroll record deleted successfully');
            loadPayrollRecords();
          } else {
            alert('Error deleting payroll record: ' + data.message);
          }
        })
        .catch(error => {
          console.error('Error deleting payroll record:', error);
          alert('Error deleting payroll record');
        });
      }
    }

    function downloadPayrollPDF(payrollId) {
      // Open PDF generation in new tab
      window.open(`/api/export/payroll-pdf/${payrollId}`, '_blank');
    }

    async function updateGuardDetailsIndex() {
      const guardId = document.getElementById('guardId').value;
      if (guardId) {
        const response = await fetch(`/api/guards/${guardId}`);
        const data = await response.json();
        if (data.success) {
          document.getElementById('guardName').value = data.data.guardName || '';
          document.getElementById('nationality').value = data.data.nationality || '';
        }
      }
    }

    async function updateAssociatedGuardNameIndex() {
      const guardId = document.getElementById('associatedGuardId').value;
      if (guardId) {
        const response = await fetch(`/api/guards/${guardId}`);
        const data = await response.json();
        if (data.success) {
          document.getElementById('associatedGuardName').value = data.data.guardName || '';
        }
      } else {
        document.getElementById('associatedGuardName').value = '';
      }
    }

    function updateClientNameIndex() {
      const clientId = document.getElementById('clientId').value;
      const selected = document.querySelector(`#clientId option[value="${clientId}"]`);
      if (selected) {
        document.getElementById('clientName').value = selected.textContent;
      }
    }

    function updatePrimaryGuardHoursIndex() {
      const totalHours = parseFloat(document.getElementById('totalHours').value) || 0;
      const totalMinutes = parseFloat(document.getElementById('totalMinutes').value) || 0;
      const associatedHours = parseFloat(document.getElementById('associatedGuardHours').value) || 0;
      
      const totalHoursDecimal = totalHours + (totalMinutes / 60);
      const primaryHours = totalHoursDecimal - associatedHours;
      
      document.getElementById('primaryGuardHours').value = primaryHours > 0 ? primaryHours.toFixed(2) : 0;
    }

    function updateTotalHoursDisplayIndex() {
      const totalHours = parseFloat(document.getElementById('totalHours').value) || 0;
      const totalMinutes = parseFloat(document.getElementById('totalMinutes').value) || 0;
      const totalHoursDecimal = totalHours + (totalMinutes / 60);
      
      const primaryHours = parseFloat(document.getElementById('primaryGuardHours').value) || 0;
      const associatedHours = parseFloat(document.getElementById('associatedGuardHours').value) || 0;
      
      document.getElementById('primaryHoursSummaryIndex').textContent = primaryHours.toFixed(1);
      document.getElementById('associatedHoursSummaryIndex').textContent = associatedHours.toFixed(1);
      document.getElementById('totalHoursSummaryIndex').textContent = totalHoursDecimal.toFixed(1);
    }

    function updateAssociatedGuardPayIndex() {
      const associatedHours = parseFloat(document.getElementById('associatedGuardHours').value) || 0;
      const payRate = parseFloat(document.getElementById('associatedGuardPayRate').value) || 0;
      const associatedPay = associatedHours * payRate;
      document.getElementById('associatedGuardPay').value = associatedPay.toFixed(2);
    }

    async function loadGuardsDropdownIndex() {
      const response = await fetch('/api/guards');
      const data = await response.json();
      if (data.success) {
        const dropdown = document.getElementById('guardId');
        const associatedDropdown = document.getElementById('associatedGuardId');
        
        dropdown.innerHTML = '<option value="">Select Guard</option>' +
          data.data.map(g => `<option value="${g._id}">${g.guardName}</option>`).join('');
        
        associatedDropdown.innerHTML = '<option value="">None</option>' +
          data.data.map(g => `<option value="${g._id}">${g.guardName}</option>`).join('');
      }
    }

    async function loadClientsDropdownIndex() {
      const response = await fetch('/api/clients');
      const data = await response.json();
      if (data.success) {
        const dropdown = document.getElementById('clientId');
        dropdown.innerHTML = '<option value="">Select Client</option>' +
          data.data.map(c => `<option value="${c._id}">${c.name}</option>`).join('');
      }
    }

    async function loadBankAccountsDropdownIndex() {
      const response = await fetch('/api/bank-accounts');
      const data = await response.json();
      if (data.success) {
        // Bank accounts are managed through the bank account cards, not in dropdown
      }
    }

    function openFormModal() {
      const modal = document.getElementById('formModal');
      if (modal) {
        modal.classList.add('active');
      }
    }

    function openAddForm() {
      document.getElementById('id').value = '';
      document.getElementById('formModalTitle').textContent = 'Add New Payroll Record';
      document.getElementById('payrollForm').reset();
      
      // Clear bank accounts and add one empty
      const container = document.getElementById('bankAccountsContainer');
      container.innerHTML = '';
      setTimeout(() => {
        if (typeof addBankAccount === 'function') {
          addBankAccount();
        }
      }, 100);
      
      openFormModal();
      
      // Load dropdowns
      loadGuardsDropdownIndex();
      loadClientsDropdownIndex();
      loadBankAccountsDropdownIndex();
    }

    async function loadPayrollRecords() {
      try {
        const response = await fetch('/api/payroll');
        const result = await response.json();

        if (result.success) {
          const tbody = document.getElementById('payrollRecordsBody');
          
          if (result.data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 2rem;">No payroll records found</td></tr>';
            return;
          }

          tbody.innerHTML = result.data.map(item => {
            const totalHours = item.totalHours || 0;
            const totalMinutes = item.totalMinutes || 0;
            const totalHoursDecimal = totalHours + (totalMinutes / 60);
            
            const hoursSpent = (item.hoursDistribution?.primaryGuardHours || 0) +
                              (item.hoursDistribution?.associatedGuardHours || 0);
            const remainingHours = totalHoursDecimal - hoursSpent;
            
            const totalPay = totalHoursDecimal * (item.payRate || 0);
            const associatedGuardName = item.hoursDistribution?.associatedGuardId?.guardName || '-';
            const associatedGuardHours = (item.hoursDistribution?.associatedGuardHours || 0).toFixed(2);
            
            // Color coding for rows based on status
            let rowBgColor = '#fff';
            if (item.status === 'completed') {
              rowBgColor = '#e8f5e9';
            } else if (item.status === 'ongoing') {
              rowBgColor = '#fff9c4';
            } else if (item.status === 'pending') {
              rowBgColor = '#ffebee';
            }
            
            return `
              <tr style="background-color: ${rowBgColor};">
                <td>${item.createdAt ? new Date(item.createdAt).toLocaleDateString() : '-'}</td>
                <td><strong>${item.guardName || '-'}</strong></td>
                <td>${item.clientName || '-'}</td>
                <td>${totalHours}h ${totalMinutes}m</td>
                <td>${hoursSpent.toFixed(2)}h</td>
                <td>${remainingHours > 0 ? remainingHours.toFixed(2) + 'h' : '0h'}</td>
                <td>${associatedGuardName}</td>
                <td>${associatedGuardName !== '-' ? associatedGuardHours + 'h' : '-'}</td>
                <td>¬£${totalPay.toFixed(2)}</td>
                <td>
                  <button onclick="openStatusModal('${item._id}')" style="background: none; border: none; cursor: pointer; padding: 4px 8px; border-radius: 4px; font-weight: 600; font-size: 12px;" 
                    class="status-badge status-${item.status || 'pending'}">
                    ${item.status === 'completed' ? 'üü¢ Completed' : item.status === 'ongoing' ? 'üü° Ongoing' : 'üî¥ Pending'}
                  </button>
                </td>
                <td>
                  <button class="action-btn edit-btn" onclick="editPayroll('${item._id}')" title="Edit">‚úèÔ∏è</button>
                  <button class="action-btn pdf-btn" onclick="downloadPayrollPDF('${item._id}')" title="PDF">üìÑ</button>
                  <button class="action-btn delete-btn" onclick="deletePayroll('${item._id}')" title="Delete">üóëÔ∏è</button>
                </td>
              </tr>
            `;
          }).join('');
        }
      } catch (error) {
        console.error('Error loading payroll records:', error);
      }
    }

    async function applyFiltersIndex() {
      const guardName = document.getElementById('filterGuard')?.value || '';
      const insuranceNumber = document.getElementById('filterInsurance')?.value || '';
      const visaStatus = document.getElementById('filterVisa')?.value || '';
      const nationality = document.getElementById('filterNationality')?.value || '';
      const clientName = document.getElementById('filterClient')?.value || '';

      const params = new URLSearchParams();
      if (guardName) params.append('guardName', guardName);
      if (insuranceNumber) params.append('insuranceNumber', insuranceNumber);
      if (visaStatus) params.append('visaStatus', visaStatus);
      if (nationality) params.append('nationality', nationality);
      if (clientName) params.append('clientName', clientName);

      try {
        const response = await fetch(`/api/payroll/filter?${params}`);
        const data = await response.json();

        if (data.success) {
          const tbody = document.getElementById('payrollRecordsBody');
          if (data.data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 2rem;">No records match your filters</td></tr>';
            return;
          }
          
          tbody.innerHTML = data.data.map(item => {
            const totalHours = item.totalHours || 0;
            const totalMinutes = item.totalMinutes || 0;
            const totalHoursDecimal = totalHours + (totalMinutes / 60);
            
            const hoursSpent = (item.hoursDistribution?.primaryGuardHours || 0) +
                              (item.hoursDistribution?.associatedGuardHours || 0);
            const remainingHours = totalHoursDecimal - hoursSpent;
            
            const totalPay = totalHoursDecimal * (item.payRate || 0);
            const associatedGuardName = item.hoursDistribution?.associatedGuardId?.guardName || '-';
            const associatedGuardHours = (item.hoursDistribution?.associatedGuardHours || 0).toFixed(2);
            
            // Color coding for rows based on status
            let rowBgColor = '#fff';
            if (item.status === 'completed') {
              rowBgColor = '#e8f5e9';
            } else if (item.status === 'ongoing') {
              rowBgColor = '#fff9c4';
            } else if (item.status === 'pending') {
              rowBgColor = '#ffebee';
            }
            
            return `
              <tr style="background-color: ${rowBgColor};">
                <td>${item.createdAt ? new Date(item.createdAt).toLocaleDateString() : '-'}</td>
                <td><strong>${item.guardName || '-'}</strong></td>
                <td>${item.clientName || '-'}</td>
                <td>${totalHours}h ${totalMinutes}m</td>
                <td>${hoursSpent.toFixed(2)}h</td>
                <td>${remainingHours > 0 ? remainingHours.toFixed(2) + 'h' : '0h'}</td>
                <td>${associatedGuardName}</td>
                <td>${associatedGuardName !== '-' ? associatedGuardHours + 'h' : '-'}</td>
                <td>¬£${totalPay.toFixed(2)}</td>
                <td>
                  <button onclick="openStatusModal('${item._id}')" style="background: none; border: none; cursor: pointer; padding: 4px 8px; border-radius: 4px; font-weight: 600; font-size: 12px;" 
                    class="status-badge status-${item.status || 'pending'}">
                    ${item.status === 'completed' ? 'üü¢ Completed' : item.status === 'ongoing' ? 'üü° Ongoing' : 'üî¥ Pending'}
                  </button>
                </td>
                <td>
                  <button class="action-btn edit-btn" onclick="editPayroll('${item._id}')" title="Edit">‚úèÔ∏è</button>
                  <button class="action-btn pdf-btn" onclick="downloadPayrollPDF('${item._id}')" title="PDF">üìÑ</button>
                  <button class="action-btn delete-btn" onclick="deletePayroll('${item._id}')" title="Delete">üóëÔ∏è</button>
                </td>
              </tr>
            `;
          }).join('');
        }
      } catch (error) {
        console.error('Error applying filters:', error);
      }
    }

    function resetFiltersIndex() {
      document.getElementById('filterGuard').value = '';
      document.getElementById('filterInsurance').value = '';
      document.getElementById('filterVisa').value = '';
      document.getElementById('filterNationality').value = '';
      document.getElementById('filterClient').value = '';
      loadPayrollRecords();
    }

    let currentEditingPayrollId = null;

    function openStatusModal(payrollId) {
      // Fetch the payroll record
      fetch(`/api/payroll/${payrollId}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const record = data.data;
            currentEditingPayrollId = payrollId;
            
            // Calculate values
            const totalHours = record.totalHours || 0;
            const totalMinutes = record.totalMinutes || 0;
            const totalHoursDecimal = totalHours + (totalMinutes / 60);
            
            const hoursSpent = (record.hoursDistribution?.primaryGuardHours || 0) +
                              (record.hoursDistribution?.associatedGuardHours || 0);
            const remainingHours = totalHoursDecimal - hoursSpent;
            
            // Populate modal
            document.getElementById('statusGuardName').textContent = record.guardName || 'N/A';
            document.getElementById('statusTotalHours').textContent = totalHoursDecimal.toFixed(2) + ' hours';
            document.getElementById('statusHoursSpent').textContent = hoursSpent.toFixed(2) + ' hours';
            document.getElementById('statusRemainingHours').textContent = remainingHours.toFixed(2) + ' hours';
            document.getElementById('statusInput').value = record.status || 'pending';
            
            // Show modal
            document.getElementById('statusModal').classList.add('active');
          }
        })
        .catch(error => console.error('Error loading payroll:', error));
    }

    function closeStatusModal() {
      document.getElementById('statusModal').classList.remove('active');
      currentEditingPayrollId = null;
    }

    function savePayrollStatus() {
      const status = document.getElementById('statusInput').value;
      
      if (!currentEditingPayrollId) {
        alert('Error: No payroll selected');
        return;
      }
      
      // Fetch the record to check remaining hours
      fetch(`/api/payroll/${currentEditingPayrollId}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const record = data.data;
            const totalHoursDecimal = (record.totalHours || 0) + ((record.totalMinutes || 0) / 60);
            const hoursSpent = (record.hoursDistribution?.primaryGuardHours || 0) +
                              (record.hoursDistribution?.associatedGuardHours || 0);
            const remainingHours = totalHoursDecimal - hoursSpent;
            
            // Check if trying to mark as completed with pending hours
            if (status === 'completed' && remainingHours > 0) {
              alert(`Cannot mark as completed. Remaining hours: ${remainingHours.toFixed(2)}h`);
              return;
            }
            
            // Update only the status field (don't send entire record)
            fetch(`/api/payroll/${currentEditingPayrollId}`, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                status: status
              })
            })
            .then(response => response.json())
            .then(result => {
              if (result.success) {
                alert('Status updated successfully');
                closeStatusModal();
                loadPayrollRecords();
              } else {
                alert('Error updating status: ' + result.message);
              }
            })
            .catch(error => {
              console.error('Error updating status:', error);
              alert('Error updating status');
            });
          }
        })
        .catch(error => console.error('Error:', error));
    }
  </script>
</body>
</html>
