<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payroll Management System</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="icon" type="image/png" href="/images/salary.png">
  <style>
    /* Global Header Styles */
    header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    header .container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
    }

    header .header-brand {
      display: flex;
      align-items: center;
      gap: 15px;
      color: white;
    }

    header .header-brand img {
      width: 50px;
      height: 50px;
      filter: drop-shadow(0 2px 5px rgba(0,0,0,0.2));
    }

    header .header-brand h1 {
      margin: 0;
      font-size: 1.8rem;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    header nav ul {
      display: flex;
      list-style: none;
      gap: 2rem;
      margin: 0;
      padding: 0;
    }

    header nav a {
      color: rgba(255, 255, 255, 0.9);
      text-decoration: none;
      font-weight: 500;
      padding: 0.5rem 1rem;
      border-radius: 5px;
      transition: all 0.3s ease;
      position: relative;
    }

    header nav a:hover {
      color: white;
      background: rgba(255, 255, 255, 0.2);
    }

    header nav a::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 0;
      height: 2px;
      background: white;
      transition: width 0.3s ease;
    }

    header nav a:hover::after {
      width: 100%;
    }

    /* Home Hero Section */
    .hero-section {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 3rem 2rem;
      text-align: center;
      margin-bottom: 3rem;
      border-radius: 15px;
    }

    .hero-section h2 {
      font-size: 2.5rem;
      margin: 0 0 1rem 0;
      font-weight: 700;
    }

    .hero-section p {
      font-size: 1.2rem;
      opacity: 0.95;
      margin: 0 0 2rem 0;
    }

    .hero-actions {
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
    }

    .hero-actions .btn {
      padding: 0.8rem 2rem;
      font-size: 1rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .hero-actions .btn-primary {
      background: white;
      color: #667eea;
    }

    .hero-actions .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }

    .hero-actions .btn-secondary {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 2px solid white;
    }

    .hero-actions .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }

    /* Pay Distribution Box */
    .pay-distribution-box {
      background: linear-gradient(135deg, #f5f7fa 0%, #e9ecf1 100%);
      border: 2px solid #d0d8e8;
      border-radius: 10px;
      padding: 2rem;
      margin: 1rem 0;
    }

    .pay-dist-row {
      display: flex;
      justify-content: space-around;
      align-items: center;
      gap: 2rem;
      margin-bottom: 1rem;
    }

    .pay-dist-item {
      text-align: center;
      flex: 1;
      padding: 1.5rem;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
    }

    .pay-dist-item:hover {
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      transform: translateY(-2px);
    }

    .pay-dist-label {
      display: block;
      font-size: 0.9rem;
      color: #666;
      font-weight: 600;
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .pay-dist-amount {
      font-size: 2rem;
      font-weight: 700;
      color: #667eea;
      margin: 0.5rem 0;
      line-height: 1;
    }

    .pay-dist-hours {
      display: block;
      font-size: 0.85rem;
      color: #999;
      margin-top: 0.5rem;
    }

    .pay-dist-icon {
      font-size: 1.5rem;
      color: #aaa;
      display: flex;
      align-items: center;
    }

    /* Metrics Grid */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 1rem;
      margin-bottom: 3rem;
    }

    .metric-card {
      background: white;
      padding: 1.2rem;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      text-align: center;
    }

    .metric-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    }

    .metric-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
    }

    .metric-card.success::before {
      background: linear-gradient(90deg, #27ae60 0%, #2ecc71 100%);
    }

    .metric-card.warning::before {
      background: linear-gradient(90deg, #f39c12 0%, #e67e22 100%);
    }

    .metric-card.danger::before {
      background: linear-gradient(90deg, #e74c3c 0%, #c0392b 100%);
    }

    .metric-label {
      font-size: 0.75rem;
      color: #888;
      font-weight: 600;
      margin-bottom: 0.4rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .metric-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: #667eea;
      margin: 0.3rem 0;
    }

    .metric-card.success .metric-value {
      color: #27ae60;
    }

    .metric-card.warning .metric-value {
      color: #f39c12;
    }

    .metric-card.danger .metric-value {
      color: #e74c3c;
    }

    .metric-unit {
      font-size: 0.7rem;
      color: #aaa;
      font-weight: 400;
    }

    /* Quick Actions */
    .quick-actions-section {
      margin: 3rem 0;
    }

    .quick-actions-section h3 {
      font-size: 1.5rem;
      color: #333;
      margin-bottom: 1.5rem;
      font-weight: 700;
    }

    /* Payroll Records Section */
    .payroll-section {
      margin: 3rem 0;
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    }

    .payroll-section h3 {
      font-size: 1.3rem;
      color: #333;
      margin-top: 0;
      margin-bottom: 1.5rem;
      font-weight: 700;
    }

    .payroll-records-container {
      overflow-x: auto;
    }

    .payroll-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    .payroll-table thead {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .payroll-table th {
      padding: 1rem;
      text-align: left;
      font-weight: 600;
    }

    .payroll-table td {
      padding: 0.9rem 1rem;
      border-bottom: 1px solid #eee;
    }

    .payroll-table tbody tr:hover {
      opacity: 0.95;
    }

    .payroll-table tbody tr:nth-child(even) {
      background-color: inherit;
    }

    /* Action Buttons in Payroll Table */
    .action-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.1rem;
      margin: 0 0.3rem;
      padding: 0.3rem 0.5rem;
      transition: transform 0.2s ease;
    }

    .action-btn:hover {
      transform: scale(1.3);
    }

    .action-btn.edit-btn:hover {
      color: #667eea;
    }

    .action-btn.pdf-btn:hover {
      color: #764ba2;
    }

    .action-btn.delete-btn:hover {
      color: #dc3545;
    }

    /* Calendar Section */
    .calendar-section {
      margin: 3rem 0;
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    }

    .calendar-section h3 {
      font-size: 1.3rem;
      color: #333;
      margin-top: 0;
      margin-bottom: 1.5rem;
      font-weight: 700;
    }

    .calendar-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.5rem;
    }

    .calendar-day {
      aspect-ratio: 1;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 0.5rem;
      text-align: center;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .calendar-day:hover {
      border-color: #667eea;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    }

    .calendar-day.has-records {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: #667eea;
      font-weight: 600;
    }

    .calendar-day.today {
      border: 2px solid #f39c12;
      font-weight: bold;
    }

    .calendar-day.other-month {
      color: #ccc;
      background: #f9f9f9;
    }

    .calendar-day-num {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.3rem;
    }

    .calendar-day-count {
      font-size: 0.7rem;
      line-height: 1.2;
    }

    @media (max-width: 768px) {
      header nav ul {
        gap: 1rem;
        font-size: 0.9rem;
      }

      header .header-brand h1 {
        font-size: 1.4rem;
      }

      .hero-section h2 {
        font-size: 1.8rem;
      }

      .metrics-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="header-brand">
        <img src="/images/salary.png" alt="Payroll Logo" class="logo">
        <h1>üíº Payroll Pro</h1>
      </div>
      <nav>
        <ul>
          <li><a href="/">üè† Home</a></li>
          <li><a href="/guards">üë• Guards</a></li>
          <li><a href="/clients">üè¢ Clients</a></li>
          <li><a href="/monthly-hours">‚è∞ Monthly Hours</a></li>
          <li><a href="/reports">üìä Reports</a></li>
          <li><a href="/upload">üì§ Upload</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main>
    <div class="container">
      <!-- Alerts -->
      <div id="alertContainer"></div>

      <!-- Hero Section -->
      <div class="hero-section">
        <h2>Welcome to Payroll Pro ‚ú®</h2>
        <p>Manage guards, track hours, and process payroll with ease</p>
        <div class="hero-actions">
          <button class="btn btn-primary" onclick="openAddForm()">‚ûï Add New Record</button>
          <button class="btn btn-secondary" onclick="document.location.href='/upload'">üì§ Upload Excel</button>
        </div>
      </div>

      <!-- Metrics Grid -->
      <div class="metrics-grid">
        <div class="metric-card">
          <div class="metric-label">Total Guards</div>
          <div class="metric-value" id="totalGuards">0</div>
          <div class="metric-unit">Active Guards</div>
        </div>

        <div class="metric-card success">
          <div class="metric-label">Hours This Month</div>
          <div class="metric-value"><span id="totalHoursValue">0</span>h</div>
          <div class="metric-unit"><span id="totalMinutesValue">0</span> minutes</div>
        </div>

        <div class="metric-card success">
          <div class="metric-label">Hours Paid</div>
          <div class="metric-value"><span id="paidHoursValue">0</span>h</div>
          <div class="metric-unit"><span id="paidMinutesValue">0</span> minutes</div>
        </div>

        <div class="metric-card success">
          <div class="metric-label">Total Hours Added (Today)</div>
          <div class="metric-value"><span id="totalHoursAdded">0</span>h</div>
          <div class="metric-unit"><span id="totalHoursAddedMinutes">0</span> minutes</div>
        </div>

        <div class="metric-card warning">
          <div class="metric-label">Hours Remaining</div>
          <div class="metric-value"><span id="remainingHoursValue">0</span>h</div>
          <div class="metric-unit"><span id="remainingMinutesValue">0</span> minutes</div>
        </div>

        <div class="metric-card warning">
          <div class="metric-label">Pending Payrolls</div>
          <div class="metric-value" id="pendingPayrolls">0</div>
          <div class="metric-unit">To be processed</div>
        </div>

        <div class="metric-card danger">
          <div class="metric-label">Expiring Alerts</div>
          <div class="metric-value" id="expiringAlerts">0</div>
          <div class="metric-unit">Share codes</div>
        </div>
      </div>
      <!-- Recent Payroll Records -->
      <div class="payroll-section">
        <h3>üìã Recent Payroll Records</h3>
        <div class="payroll-records-container">
          <table class="payroll-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Guard Name</th>
                <th>Client</th>
                <th>Total Hours</th>
                <th>Hours Spent</th>
                <th>Remaining Hours</th>
                <th>Associated Guard</th>
                <th>Total Pay</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="payrollRecordsBody">
              <tr><td colspan="10" style="text-align: center; padding: 2rem;">Loading records...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Payroll Calendar -->
      <div class="calendar-section">
        <h3>üìÖ Payroll by Day</h3>
        <div class="calendar-controls">
          <button onclick="previousCalendarMonth()" class="btn btn-sm">‚óÄ Previous</button>
          <span id="calendarMonthLabel" style="font-weight: bold; margin: 0 1rem;">Current Month</span>
          <button onclick="nextCalendarMonth()" class="btn btn-sm">Next ‚ñ∂</button>
        </div>
        <div class="calendar-grid" id="payrollCalendar">
          <!-- Calendar will be populated by JavaScript -->
        </div>
      </div>
    </div>
  </main>

  <!-- Form Modal -->
  <div id="formModal" class="modal">
    <div class="modal-content modal-professional" style="max-height: 90vh; overflow-y: auto;">
      <div class="modal-header-professional" style="position: sticky; top: 0; background: white; z-index: 100;">
        <div class="modal-title-section">
          <div class="modal-icon">üìã</div>
          <div>
            <h2 id="formModalTitle">Add New Payroll Record</h2>
            <p class="modal-subtitle">Enter complete guard and payment information</p>
          </div>
        </div>
        <button class="modal-close-btn" onclick="closeFormModal()">‚úï</button>
      </div>
      
      <form id="payrollForm">
        <input type="hidden" id="id" name="id">
        
        <!-- SECTION 1: Guard Basic Information -->
        <div class="form-section">
          <h3 class="section-title">üë§ Guard Basic Information</h3>
          <div class="form-row-2col">
            <div class="form-group">
              <label>Guard <span class="required">*</span></label>
              <select id="guardId" name="guardId" required onchange="updateGuardDetailsIndex()">
                <option value="">Select Guard</option>
              </select>
              <small class="field-hint">Select from available guards</small>
            </div>
            <div class="form-group">
              <label>Nationality <span class="required">*</span></label>
              <input type="text" id="nationality" name="nationality" readonly style="background-color: #f5f5f5;">
              <small class="field-hint">Auto-populated from guard selection</small>
            </div>
          </div>
          <div class="form-row-2col">
            <div class="form-group">
              <label>Guard Name (Display)</label>
              <input type="text" id="guardName" name="guardName" readonly style="background-color: #f5f5f5;">
              <small class="field-hint">Auto-populated from selection</small>
            </div>
          <div class="form-row-2col">
            <div class="form-group">
              <label>Insurance Number <span class="required">*</span></label>
              <input type="text" id="insuranceNumber" name="insuranceNumber" placeholder="e.g., AB 123 456 C" required>
              <small class="field-hint">National Insurance: AB 123 456 C</small>
            </div>
            <div class="form-group">
              <label>Site Name</label>
              <input type="text" id="siteName" name="siteName" placeholder="e.g., Arnold Laver Peterborough">
              <small class="field-hint">Work location (optional)</small>
            </div>
          </div>
        </div>

        <!-- SECTION 2: Immigration & Visa Status -->
        <div class="form-section">
          <h3 class="section-title">üõÇ Immigration & Visa Status</h3>
          <div class="form-row-2col">
            <div class="form-group">
              <label>Visa Status <span class="required">*</span></label>
              <select id="visaStatus" name="visaStatus" required onchange="toggleShareCodeFields()">
                <option value="">-- Select Visa Status --</option>
                <option value="Student">Student</option>
                <option value="Skilled Worker">Skilled Worker</option>
                <option value="PSW">PSW (Points-Based System)</option>
                <option value="Dependent/Spouse">Dependent/Spouse</option>
                <option value="Permanent Resident">Permanent Resident</option>
                <option value="Settled Status">Settled Status</option>
                <option value="Pre-Settled Status">Pre-Settled Status</option>
                <option value="Refugee/Asylum">Refugee/Asylum Seeker</option>
              </select>
              <small class="field-hint">Immigration status classification</small>
            </div>
            <div class="form-group">
              <label>
                <input type="checkbox" id="britishPassport" name="britishPassport" onchange="toggleShareCodeFields()">
                British Passport Holder
              </label>
              <small class="field-hint">Check if has British passport</small>
            </div>
          </div>
          
          <!-- Share Code Fields (shown only if NOT British Passport) -->
          <div id="shareCodeContainer" style="display: none;">
            <div class="form-row-2col">
              <div class="form-group">
                <label>Share Code <span class="required">*</span></label>
                <input type="text" id="shareCode" name="shareCode" placeholder="Enter share code">
                <small class="field-hint">Required for non-British passport holders</small>
              </div>
              <div class="form-group">
                <label>Share Code Expiry Date <span class="required">*</span></label>
                <input type="date" id="shareCodeExpiryDate" name="shareCodeExpiryDate">
                <small class="field-hint">When share code expires</small>
              </div>
            </div>
          </div>
        </div>

        <!-- SECTION 3: Client Information -->
        <div class="form-section">
          <h3 class="section-title">üè¢ Client Information</h3>
          <div class="form-row-2col">
            <div class="form-group">
              <label>Client Name <span class="required">*</span></label>
              <select id="clientId" name="clientId" required onchange="updateClientNameIndex()">
                <option value="">Select Client</option>
              </select>
              <small class="field-hint">Select from available clients</small>
            </div>
            <div class="form-group">
              <label>Client Name (Display)</label>
              <input type="text" id="clientName" name="clientName" readonly style="background-color: #f5f5f5;">
              <small class="field-hint">Auto-populated from selection</small>
            </div>
          </div>
        </div>

        <!-- SECTION 4: Working Hours -->
        <div class="form-section">
          <h3 class="section-title">‚è∞ Working Hours</h3>
          <div class="form-row-2col">
            <div class="form-group">
              <label>Total Hours <span class="required">*</span></label>
              <input type="number" id="totalHours" name="totalHours" min="0" placeholder="e.g., 40" required onchange="calculateTotalPay(); updateTotalHoursDisplayIndex();">
              <small class="field-hint">Number of hours worked</small>
            </div>
            <div class="form-group">
              <label>Total Minutes <span class="required">*</span></label>
              <input type="number" id="totalMinutes" name="totalMinutes" min="0" max="59" placeholder="e.g., 30" required onchange="calculateTotalPay();">
              <small class="field-hint">Minutes (0-59)</small>
            </div>
          </div>
          <!-- Dynamic Total Hours Summary -->
          <div class="form-group" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 5px; color: white; margin: 10px 0;">
            <label style="color: white; margin-bottom: 5px; display: block;">üìä Total Hours Summary</label>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
              <div style="padding: 10px; background: rgba(255,255,255,0.2); border-radius: 5px; text-align: center;">
                <small style="display: block; opacity: 0.9;">Primary Guard</small>
                <strong id="primaryHoursSummaryIndex" style="font-size: 1.3em;">0.0</strong> hrs
              </div>
              <div style="padding: 10px; background: rgba(255,255,255,0.2); border-radius: 5px; text-align: center;">
                <small style="display: block; opacity: 0.9;">Associated Guard</small>
                <strong id="associatedHoursSummaryIndex" style="font-size: 1.3em;">0.0</strong> hrs
              </div>
            </div>
            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.3); text-align: center;">
              <small style="display: block; opacity: 0.9;">Total Hours</small>
              <strong id="totalHoursSummaryIndex" style="font-size: 1.5em;">0.0</strong> hrs
            </div>
          </div>
        </div>

        <!-- SECTION 4A: Associated Guard -->
        <div class="form-section">
          <h3 class="section-title">üë• Associated Guard (Optional)</h3>
          <div class="form-row-2col">
            <div class="form-group">
              <label>Associated Guard</label>
              <select id="associatedGuardId" name="associatedGuardId" onchange="updateAssociatedGuardNameIndex(); updateTotalHoursDisplayIndex();">
                <option value="">None</option>
              </select>
              <small class="field-hint">Assign hours to another guard</small>
            </div>
            <div class="form-group">
              <label>Associated Guard Name</label>
              <input type="text" id="associatedGuardName" name="associatedGuardName" readonly style="background-color: #f5f5f5;">
              <small class="field-hint">Auto-populated from selection</small>
            </div>
          </div>
          <div class="form-row-2col">
            <div class="form-group">
              <label>Hours to Transfer (Optional)</label>
              <input type="number" id="associatedGuardHours" name="associatedGuardHours" step="0.5" min="0" onchange="updatePrimaryGuardHoursIndex(); updateTotalHoursDisplayIndex(); updatePayDistribution();">
              <small class="field-hint">Hours for associated guard</small>
            </div>
            <div class="form-group">
              <label>Associated Guard Pay Rate (¬£/hour)</label>
              <input type="number" id="associatedGuardPayRate" name="associatedGuardPayRate" step="0.01" min="0" onchange="updateAssociatedGuardPayIndex(); updatePayDistribution();">
              <small class="field-hint">Hourly rate for associated guard</small>
            </div>
          </div>
          <div class="form-row-2col">
            <div class="form-group">
              <label>Associated Guard Total Pay (¬£)</label>
              <input type="number" id="associatedGuardPay" name="associatedGuardPay" step="0.01" min="0" readonly style="background-color: #f5f5f5;">
              <small class="field-hint">Auto-calculated</small>
            </div>
            <div class="form-group">
              <label>Primary Guard Hours</label>
              <input type="number" id="primaryGuardHours" name="primaryGuardHours" step="0.5" min="0" readonly style="background-color: #f5f5f5;">
              <small class="field-hint">Auto-calculated (Total - Associated)</small>
            </div>
          </div>
        </div>

        <!-- SECTION 5: Rates -->
        <div class="form-section">
          <h3 class="section-title">üí∑ Rates</h3>
          <div class="form-row-2col">
            <div class="form-group">
              <label>Charge Rate <span class="currency">¬£/hour</span> <span class="required">*</span></label>
              <input type="number" id="chargeRate" name="chargeRate" step="0.01" min="0" placeholder="e.g., 18.75" required>
              <small class="field-hint">What client pays per hour</small>
            </div>
            <div class="form-group">
              <label>Pay Rate <span class="currency">¬£/hour</span> <span class="required">*</span></label>
              <input type="number" id="payRate" name="payRate" step="0.01" min="0" placeholder="e.g., 12.50" required onchange="calculateTotalPay()">
              <small class="field-hint">What guard is paid per hour</small>
            </div>
          </div>
          <div class="form-group">
            <p style="background: #f0f4ff; padding: 10px; border-radius: 5px; margin: 10px 0;">
              <strong>Calculated Total Pay:</strong> <span id="totalPayDisplay">¬£0.00</span>
            </p>
          </div>
        </div>

        <!-- SECTION 5.5: Pay Distribution -->
        <div class="form-section">
          <h3 class="section-title">üí∞ Pay Distribution</h3>
          <div class="pay-distribution-box">
            <div class="pay-dist-row">
              <div class="pay-dist-item">
                <label class="pay-dist-label">Primary Guard</label>
                <div class="pay-dist-amount" id="primaryGuardPayDisplay">¬£0.00</div>
                <span class="pay-dist-hours" id="primaryGuardHoursDisplay">0h</span>
              </div>
              <div class="pay-dist-icon">‚ÜîÔ∏è</div>
              <div class="pay-dist-item">
                <label class="pay-dist-label">Associated Guard</label>
                <div class="pay-dist-amount" id="associatedGuardPayDisplay">¬£0.00</div>
                <span class="pay-dist-hours" id="associatedGuardHoursDisplay">0h</span>
              </div>
            </div>
            <div style="text-align: center; margin-top: 1rem; padding: 1rem; background: #fffbf0; border-radius: 5px;">
              <strong>Total Pay:</strong> <span id="totalPaySummary">¬£0.00</span>
            </div>
          </div>
        </div>

        <!-- SECTION 6: Bank Accounts (Multiple) -->
        <div class="form-section">
          <h3 class="section-title">üè¶ Bank Account(s)</h3>
          <p style="color: #666; margin-bottom: 15px;">Add one or more bank accounts for payment distribution</p>
          
          <div id="bankAccountsContainer">
            <!-- Bank accounts will be added here dynamically -->
          </div>
          
          <button type="button" class="btn btn-info" onclick="addBankAccount()">
            ‚ûï Add Another Bank Account
          </button>
        </div>

        <!-- SECTION 7: Legacy Payment Amounts (for backward compatibility) -->
        <div class="form-section">
          <h3 class="section-title">üí∑ Legacy Payment Amounts</h3>
          <p style="color: #999; margin-bottom: 15px;">These fields are for backward compatibility. Use bank account distribution above.</p>
          <div class="form-row-3col">
            <div class="form-group">
              <label>Pay 1 <span class="currency">¬£</span></label>
              <input type="number" id="pay1" name="pay1" step="0.01" min="0" placeholder="e.g., 500">
              <small class="field-hint">Payroll 01</small>
            </div>
            <div class="form-group">
              <label>Pay 2 <span class="currency">¬£</span></label>
              <input type="number" id="pay2" name="pay2" step="0.01" min="0" placeholder="e.g., 550">
              <small class="field-hint">Payroll 02</small>
            </div>
            <div class="form-group">
              <label>Pay 3 <span class="currency">¬£</span></label>
              <input type="number" id="pay3" name="pay3" step="0.01" min="0" placeholder="e.g., 600">
              <small class="field-hint">Payroll 03</small>
            </div>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions-professional">
          <button type="button" class="btn btn-secondary btn-large" onclick="closeFormModal()">Cancel</button>
          <button type="submit" class="btn btn-primary btn-large">üíæ Save Record</button>
        </div>
      </form>
    </div>
  </div>

  <script src="/js/main.js"></script>
  <script src="/js/form-handler.js"></script>
  <script>
    let guardsDataIndex = [];
    let clientsDataIndex = [];
    let bankAccountsDataIndex = [];

    // Load data when modal is opened
    document.addEventListener('DOMContentLoaded', () => {
      // Hook to modal open
      const formModal = document.getElementById('formModal');
      if (formModal) {
        const observer = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            if (mutation.attributeName === 'class' && formModal.classList.contains('active')) {
              loadGuardsDropdownIndex();
              loadClientsDropdownIndex();
              loadBankAccountsDropdownIndex();
            }
          });
        });
        observer.observe(formModal, { attributes: true });
      }
    });

    async function loadGuardsDropdownIndex() {
      try {
        const response = await fetch('/api/guards');
        const result = await response.json();
        if (result.success) {
          guardsDataIndex = result.data;
          const dropdown = document.getElementById('guardId');
          if (dropdown) {
            dropdown.innerHTML = '<option value="">Select Guard</option>' +
              result.data.map(guard => `
                <option value="${guard._id}" data-guard-name="${guard.guardName}" data-nationality="${guard.nationality}">${guard.guardName}</option>
              `).join('');
            loadAssociatedGuardsDropdownIndex();
          }
        }
      } catch (error) {
        console.error('Error loading guards:', error);
      }
    }

    async function loadClientsDropdownIndex() {
      try {
        const response = await fetch('/api/clients');
        const result = await response.json();
        if (result.success) {
          clientsDataIndex = result.data;
          const dropdown = document.getElementById('clientId');
          if (dropdown) {
            dropdown.innerHTML = '<option value="">Select Client</option>' +
              result.data.map(client => `
                <option value="${client._id}" data-client-name="${client.name}">${client.name}</option>
              `).join('');
          }
        }
      } catch (error) {
        console.error('Error loading clients:', error);
      }
    }

    async function loadBankAccountsDropdownIndex() {
      try {
        const response = await fetch('/api/bank-accounts');
        const result = await response.json();
        if (result.success) {
          bankAccountsDataIndex = result.data;
        }
      } catch (error) {
        console.error('Error loading bank accounts:', error);
      }
    }

    function loadAssociatedGuardsDropdownIndex() {
      const dropdown = document.getElementById('associatedGuardId');
      const currentGuardId = document.getElementById('guardId').value;
      if (dropdown && guardsDataIndex.length > 0) {
        dropdown.innerHTML = '<option value="">None</option>' +
          guardsDataIndex
            .filter(guard => guard._id !== currentGuardId)
            .map(guard => `
              <option value="${guard._id}" data-guard-name="${guard.guardName}">${guard.guardName}</option>
            `).join('');
      }
    }

    function updateGuardDetailsIndex() {
      const guardId = document.getElementById('guardId').value;
      const selected = document.querySelector(`#guardId option[value="${guardId}"]`);
      if (selected) {
        document.getElementById('guardName').value = selected.dataset.guardName;
        document.getElementById('nationality').value = selected.dataset.nationality;
        document.getElementById('associatedGuardId').value = '';
        document.getElementById('associatedGuardName').value = '';
        document.getElementById('associatedGuardHours').value = '';
        document.getElementById('primaryGuardHours').value = '';
        loadAssociatedGuardsDropdownIndex();
      } else {
        document.getElementById('guardName').value = '';
        document.getElementById('nationality').value = '';
      }
    }

    function updateClientNameIndex() {
      const clientId = document.getElementById('clientId').value;
      const selected = document.querySelector(`#clientId option[value="${clientId}"]`);
      if (selected) {
        document.getElementById('clientName').value = selected.dataset.clientName;
      } else {
        document.getElementById('clientName').value = '';
      }
    }

    function updateAssociatedGuardNameIndex() {
      const associatedId = document.getElementById('associatedGuardId').value;
      const selected = document.querySelector(`#associatedGuardId option[value="${associatedId}"]`);
      if (selected) {
        document.getElementById('associatedGuardName').value = selected.dataset.guardName;
      } else {
        document.getElementById('associatedGuardName').value = '';
      }
    }

    function updatePrimaryGuardHoursIndex() {
      const totalHours = parseFloat(document.getElementById('totalHours').value) || 0;
      const associatedHours = parseFloat(document.getElementById('associatedGuardHours').value) || 0;
      const primaryHours = totalHours - associatedHours;
      document.getElementById('primaryGuardHours').value = primaryHours > 0 ? primaryHours.toFixed(2) : 0;
      updateAssociatedGuardPayIndex();
    }

    function updateAssociatedGuardPayIndex() {
      const associatedHours = parseFloat(document.getElementById('associatedGuardHours').value) || 0;
      const associatedPayRate = parseFloat(document.getElementById('associatedGuardPayRate').value) || 0;
      const totalPay = associatedHours * associatedPayRate;
      document.getElementById('associatedGuardPay').value = totalPay.toFixed(2);
    }

    function updateTotalHoursDisplayIndex() {
      const totalHours = parseFloat(document.getElementById('totalHours').value) || 0;
      const associatedHours = parseFloat(document.getElementById('associatedGuardHours').value) || 0;
      const primaryHours = Math.max(0, totalHours - associatedHours);
      
      document.getElementById('totalHoursSummaryIndex').textContent = totalHours.toFixed(1);
      document.getElementById('primaryHoursSummaryIndex').textContent = primaryHours.toFixed(1);
      document.getElementById('associatedHoursSummaryIndex').textContent = associatedHours.toFixed(1);
    }

    // ============ PAYROLL RECORDS AND CALENDAR ============

    let currentCalendarMonth = new Date();

    function loadPayrollRecords() {
      fetch('/api/payroll')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const records = data.data.slice(0, 10); // Show last 10 records
            const tbody = document.getElementById('payrollRecordsBody');
            
            if (records.length === 0) {
              tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 2rem; color: #999;">No payroll records found</td></tr>';
              return;
            }

            tbody.innerHTML = records.map(record => {
              const date = new Date(record.createdAt).toLocaleDateString();
              const associatedGuardName = record.hoursDistribution?.associatedGuardName || '-';
              const associatedGuardHours = record.hoursDistribution?.associatedGuardHours || 0;
              const primaryGuardHours = record.hoursDistribution?.primaryGuardHours || 0;
              const totalHoursDecimal = record.totalHours + (record.totalMinutes / 60);
              const hoursSpent = primaryGuardHours + associatedGuardHours;
              const remainingHours = totalHoursDecimal - hoursSpent;
              const totalPay = (totalHoursDecimal * (record.payRate || 0)).toFixed(2);
              const status = record.status || 'pending';
              
              // Color coding based on status
              let statusColor, statusText, rowBackgroundColor;
              if (status === 'completed') {
                statusColor = '#28a745';
                statusText = '‚úì Completed';
                rowBackgroundColor = '#e8f5e9';
              } else if (status === 'ongoing') {
                statusColor = '#ffc107';
                statusText = '‚ü≥ Ongoing';
                rowBackgroundColor = '#fff9c4';
              } else {
                statusColor = '#dc3545';
                statusText = '‚äò Pending';
                rowBackgroundColor = '#ffebee';
              }
              
              return `
                <tr style="background-color: ${rowBackgroundColor};">
                  <td>${date}</td>
                  <td><strong>${record.guardName || '-'}</strong></td>
                  <td>${record.clientName || '-'}</td>
                  <td>${totalHoursDecimal.toFixed(2)}h</td>
                  <td>${hoursSpent.toFixed(2)}h</td>
                  <td>${remainingHours.toFixed(2)}h</td>
                  <td>${associatedGuardName}</td>
                  <td>¬£${totalPay}</td>
                  <td><span style="background: ${statusColor}; color: white; padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">${statusText}</span></td>
                  <td>
                    <button class="action-btn edit-btn" onclick="editPayroll('${record._id}')" title="Edit">‚úèÔ∏è</button>
                    <button class="action-btn pdf-btn" onclick="downloadPayrollPDF('${record._id}')" title="Download PDF">üìÑ</button>
                    <button class="action-btn delete-btn" onclick="deletePayroll('${record._id}')" title="Delete">üóëÔ∏è</button>
                  </td>
                </tr>
              `;
            }).join('');
          }
        })
        .catch(error => {
          console.error('Error loading payroll records:', error);
          const tbody = document.getElementById('payrollRecordsBody');
          tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 2rem; color: #999;">Error loading records</td></tr>';
        });
    }

    function renderPayrollCalendar() {
      fetch('/api/payroll')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const records = data.data;
            const year = currentCalendarMonth.getFullYear();
            const month = currentCalendarMonth.getMonth();

            // Count records by date
            const recordsByDate = {};
            records.forEach(record => {
              const recordDate = new Date(record.createdAt);
              if (recordDate.getFullYear() === year && recordDate.getMonth() === month) {
                const day = recordDate.getDate();
                recordsByDate[day] = (recordsByDate[day] || 0) + 1;
              }
            });

            // Render calendar
            const monthLabel = currentCalendarMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            document.getElementById('calendarMonthLabel').textContent = monthLabel;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();

            let html = '';
            const today = new Date();
            const todayDate = today.getDate();
            const isThisMonth = today.getFullYear() === year && today.getMonth() === month;

            // Empty cells for days before month starts
            for (let i = 0; i < startingDayOfWeek; i++) {
              html += '<div class="calendar-day other-month"></div>';
            }

            // Days of month
            for (let day = 1; day <= daysInMonth; day++) {
              const hasRecords = recordsByDate[day] || 0;
              const isTodayClass = isThisMonth && day === todayDate ? 'today' : '';
              const hasRecordsClass = hasRecords > 0 ? 'has-records' : '';
              
              html += `
                <div class="calendar-day ${isTodayClass} ${hasRecordsClass}">
                  <div class="calendar-day-num">${day}</div>
                  ${hasRecords > 0 ? `<div class="calendar-day-count">${hasRecords} record${hasRecords > 1 ? 's' : ''}</div>` : ''}
                </div>
              `;
            }

            document.getElementById('payrollCalendar').innerHTML = html;
          }
        })
        .catch(error => console.error('Error rendering calendar:', error));
    }

    function previousCalendarMonth() {
      currentCalendarMonth = new Date(currentCalendarMonth.getFullYear(), currentCalendarMonth.getMonth() - 1, 1);
      renderPayrollCalendar();
    }

    function nextCalendarMonth() {
      currentCalendarMonth = new Date(currentCalendarMonth.getFullYear(), currentCalendarMonth.getMonth() + 1, 1);
      renderPayrollCalendar();
    }

    // Load data on page load
    function loadMetrics() {
      // Load total guards
      fetch('/api/guards')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const activeGuards = data.data.filter(g => g.active).length;
            document.getElementById('totalGuards').textContent = activeGuards;
          }
        })
        .catch(error => console.error('Error loading guards:', error));

      // Load payroll metrics
      fetch('/api/payroll')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const records = data.data;
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();

            let totalHours = 0;
            let totalMinutes = 0;
            let paidHours = 0;
            let paidMinutes = 0;
            let todayHours = 0;
            let todayMinutes = 0;
            let pendingCount = 0;
            let expiringAlerts = 0;

            records.forEach(record => {
              const recordDate = new Date(record.createdAt);
              
              // Count this month's records
              if (recordDate.getMonth() === currentMonth && recordDate.getFullYear() === currentYear) {
                totalHours += record.totalHours || 0;
                totalMinutes += record.totalMinutes || 0;
                
                // Count paid hours (hours spent)
                if (record.hoursDistribution) {
                  paidHours += (record.hoursDistribution.primaryGuardHours || 0);
                  paidHours += (record.hoursDistribution.associatedGuardHours || 0);
                }
              }

              // Count today's records
              if (recordDate.toDateString() === today.toDateString()) {
                todayHours += record.totalHours || 0;
                todayMinutes += record.totalMinutes || 0;
              }

              // Count pending payrolls
              if (record.status === 'pending') {
                pendingCount++;
              }

              // Count expiring share codes
              if (record.shareCodeExpiryDate) {
                const expiryDate = new Date(record.shareCodeExpiryDate);
                const daysUntilExpiry = Math.floor((expiryDate - today) / (1000 * 60 * 60 * 24));
                if (daysUntilExpiry >= 0 && daysUntilExpiry <= 30) {
                  expiringAlerts++;
                }
              }
            });

            // Convert total minutes to hours
            totalHours += Math.floor(totalMinutes / 60);
            totalMinutes = totalMinutes % 60;

            todayHours += Math.floor(todayMinutes / 60);
            todayMinutes = todayMinutes % 60;

            // Update metric boxes
            document.getElementById('totalHoursValue').textContent = totalHours;
            document.getElementById('totalMinutesValue').textContent = totalMinutes;
            document.getElementById('paidHoursValue').textContent = Math.floor(paidHours);
            document.getElementById('paidMinutesValue').textContent = Math.floor((paidHours % 1) * 60);
            document.getElementById('totalHoursAdded').textContent = todayHours;
            document.getElementById('totalHoursAddedMinutes').textContent = todayMinutes;
            
            const totalHoursDecimal = totalHours + (totalMinutes / 60);
            const remainingHours = totalHoursDecimal - paidHours;
            document.getElementById('remainingHoursValue').textContent = Math.floor(remainingHours);
            document.getElementById('remainingMinutesValue').textContent = Math.floor((remainingHours % 1) * 60);
            
            document.getElementById('pendingPayrolls').textContent = pendingCount;
            document.getElementById('expiringAlerts').textContent = expiringAlerts;
          }
        })
        .catch(error => console.error('Error loading payroll metrics:', error));
    }

    function editPayroll(payrollId) {
      // Fetch the payroll record
      fetch(`/api/payroll/${payrollId}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const record = data.data;
            
            // Populate form with record data
            document.getElementById('id').value = record._id;
            document.getElementById('guardId').value = record.guardId || '';
            document.getElementById('guardName').value = record.guardName || '';
            document.getElementById('nationality').value = record.nationality || '';
            document.getElementById('insuranceNumber').value = record.insuranceNumber || '';
            document.getElementById('visaStatus').value = record.visaStatus || '';
            document.getElementById('siteName').value = record.siteName || '';
            document.getElementById('clientName').value = record.clientName || '';
            document.getElementById('totalHours').value = record.totalHours || 0;
            document.getElementById('totalMinutes').value = record.totalMinutes || 0;
            document.getElementById('chargeRate').value = record.chargeRate || 0;
            document.getElementById('payRate').value = record.payRate || 0;
            
            // Update title
            document.getElementById('formModalTitle').textContent = 'Edit Payroll Record';
            
            // Open modal
            openFormModal();
          }
        })
        .catch(error => console.error('Error loading payroll record:', error));
    }

    function deletePayroll(payrollId) {
      if (confirm('Are you sure you want to delete this payroll record? This action cannot be undone.')) {
        fetch(`/api/payroll/${payrollId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Payroll record deleted successfully');
            loadPayrollRecords();
          } else {
            alert('Error deleting payroll record: ' + data.message);
          }
        })
        .catch(error => {
          console.error('Error deleting payroll record:', error);
          alert('Error deleting payroll record');
        });
      }
    }

    function downloadPayrollPDF(payrollId) {
      // Open PDF generation in new tab
      window.open(`/api/payroll/generate-pdf/${payrollId}`, '_blank');
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadMetrics();
      loadPayrollRecords();
      renderPayrollCalendar();
    });
  </script>
</body>
</html>
