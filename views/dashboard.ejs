<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Payroll System</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="icon" type="image/png" href="/images/salary.png">
  <style>
    /* Global Header */
    header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    header .container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      max-width: 1200px;
      margin: 0 auto;
    }

    header .header-brand {
      display: flex;
      align-items: center;
      gap: 15px;
      color: white;
    }

    header .header-brand img {
      width: 40px;
      height: 40px;
    }

    header .header-brand h1 {
      margin: 0;
      font-size: 1.6rem;
      font-weight: 700;
    }

    header nav ul {
      list-style: none;
      display: flex;
      gap: 2rem;
      margin: 0;
      padding: 0;
    }

    header nav a {
      color: rgba(255, 255, 255, 0.9);
      text-decoration: none;
      font-weight: 500;
      padding: 0.5rem 1rem;
      border-radius: 5px;
      transition: all 0.3s ease;
      position: relative;
    }

    header nav a:hover {
      color: white;
      background: rgba(255, 255, 255, 0.2);
    }

    header nav a::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 0;
      height: 2px;
      background: white;
      transition: width 0.3s ease;
    }

    header nav a:hover::after {
      width: 100%;
    }
    .dashboard-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .dashboard-header {
      margin-bottom: 30px;
    }

    .dashboard-header h1 {
      margin: 0 0 10px 0;
      font-size: 2.5em;
      color: #333;
    }

    .header-subtitle {
      color: #666;
      font-size: 16px;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .metric-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px 25px;
      border-radius: 10px;
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
      transition: transform 0.3s, box-shadow 0.3s;
    }

    .metric-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
    }

    .metric-card.warning {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      box-shadow: 0 5px 20px rgba(245, 87, 108, 0.3);
    }

    .metric-card.warning:hover {
      box-shadow: 0 10px 30px rgba(245, 87, 108, 0.4);
    }

    .metric-card.success {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      box-shadow: 0 5px 20px rgba(79, 172, 254, 0.3);
    }

    .metric-card.success:hover {
      box-shadow: 0 10px 30px rgba(79, 172, 254, 0.4);
    }

    .metric-label {
      font-size: 13px;
      opacity: 0.9;
      margin-bottom: 12px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .metric-value {
      font-size: 42px;
      font-weight: 700;
      line-height: 1;
      margin-bottom: 8px;
    }

    .metric-unit {
      font-size: 12px;
      opacity: 0.85;
    }

    .content-section {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 30px;
      margin-bottom: 30px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid #eee;
    }

    .section-title {
      font-size: 1.4em;
      font-weight: 600;
      color: #333;
      margin: 0;
    }

    .section-actions {
      display: flex;
      gap: 10px;
    }

    .btn-secondary {
      background-color: #f0f0f0;
      color: #333;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }

    .btn-secondary:hover {
      background-color: #e0e0e0;
    }

    .alerts-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
    }

    .alert-item {
      border-left: 5px solid #ff9800;
      padding: 20px;
      background-color: #fff8f0;
      border-radius: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s;
    }

    .alert-item:hover {
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
    }

    .alert-item.critical {
      border-left-color: #f44336;
      background-color: #ffebee;
    }

    .alert-item.warning {
      border-left-color: #ff9800;
      background-color: #fff3e0;
    }

    .alert-item.info {
      border-left-color: #2196f3;
      background-color: #e3f2fd;
    }

    .alert-content {
      flex: 1;
    }

    .alert-title {
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
    }

    .alert-description {
      font-size: 13px;
      color: #666;
    }

    .alert-actions {
      display: flex;
      gap: 10px;
      margin-left: 20px;
    }

    .btn-small {
      background: none;
      border: 1px solid #ddd;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }

    .btn-small:hover {
      background-color: rgba(0, 0, 0, 0.05);
    }

    .alert-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 10px;
    }

    .badge-critical {
      background-color: #f44336;
      color: white;
    }

    .badge-warning {
      background-color: #ff9800;
      color: white;
    }

    .badge-info {
      background-color: #2196f3;
      color: white;
    }

    .table-container {
      overflow-x: auto;
    }

    .payroll-table {
      width: 100%;
      border-collapse: collapse;
    }

    .payroll-table th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      text-align: left;
      font-weight: 600;
    }

    .payroll-table td {
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
    }

    .payroll-table tr:hover {
      background-color: #f9f9f9;
    }

    .status-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-pending {
      background-color: #fff3e0;
      color: #e65100;
    }

    .status-paid {
      background-color: #e8f5e9;
      color: #2e7d32;
    }

    .status-cancelled {
      background-color: #ffebee;
      color: #c62828;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #999;
    }

    .quick-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .quick-action-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 15px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
      text-align: center;
      text-decoration: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .quick-action-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }

    .quick-action-btn.secondary {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .quick-action-btn.success {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .stat-box {
      background: linear-gradient(135deg, #f5f5f5 0%, #ffffff 100%);
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #eee;
    }

    .stat-box-label {
      font-size: 13px;
      color: #666;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .stat-box-value {
      font-size: 32px;
      font-weight: 700;
      color: #333;
    }

    @media (max-width: 768px) {
      .metrics-grid {
        grid-template-columns: 1fr;
      }

      .alert-item {
        flex-direction: column;
        align-items: flex-start;
      }

      .alert-actions {
        margin-left: 0;
        margin-top: 15px;
        width: 100%;
      }

      .dashboard-header h1 {
        font-size: 1.8em;
      }
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #999;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- Global Header -->
  <header>
    <div class="container">
      <div class="header-brand">
        <img src="/images/salary.png" alt="Payroll Logo" class="logo">
        <h1>üíº Payroll Pro</h1>
      </div>
      <nav>
        <ul>
          <li><a href="/">üè† Home</a></li>
          <li><a href="/guards">üë• Guards</a></li>
          <li><a href="/clients">üè¢ Clients</a></li>
          <li><a href="/monthly-hours">‚è∞ Monthly Hours</a></li>
          <li><a href="/reports">üìä Reports</a></li>
          <li><a href="/upload">üì§ Upload</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <div class="dashboard-container">
    <!-- Header -->
    <div class="dashboard-header">
      <h1>Dashboard</h1>
      <p class="header-subtitle">Welcome back! Here's your payroll overview.</p>
    </div>

    <!-- Metrics Grid -->
    <div class="metrics-grid">
      <div class="metric-card">
        <div class="metric-label">Total Guards</div>
        <div class="metric-value" id="totalGuards">0</div>
        <div class="metric-unit">Active Guards</div>
      </div>

      <div class="metric-card success">
        <div class="metric-label">Hours This Month</div>
        <div class="metric-value"><span id="totalHoursValue">0</span>h</div>
        <div class="metric-unit"><span id="totalMinutesValue">0</span> minutes</div>
      </div>

      <div class="metric-card success">
        <div class="metric-label">Total Hours Added (Today)</div>
        <div class="metric-value"><span id="totalHoursAdded">0</span>h</div>
        <div class="metric-unit"><span id="totalHoursAddedMinutes">0</span> minutes</div>
      </div>

      <div class="metric-card success">
        <div class="metric-label">Hours Paid</div>
        <div class="metric-value"><span id="paidHoursValue">0</span>h</div>
        <div class="metric-unit"><span id="paidMinutesValue">0</span> minutes</div>
      </div>

      <div class="metric-card warning">
        <div class="metric-label">Hours Remaining</div>
        <div class="metric-value"><span id="remainingHoursValue">0</span>h</div>
        <div class="metric-unit"><span id="remainingMinutesValue">0</span> minutes</div>
      </div>

      <div class="metric-card warning">
        <div class="metric-label">Pending Payrolls</div>
        <div class="metric-value" id="pendingPayrolls">0</div>
        <div class="metric-unit">To be processed</div>
      </div>

      <div class="metric-card">
        <div class="metric-label">Expiring Alerts</div>
        <div class="metric-value" id="expiringAlerts">0</div>
        <div class="metric-unit">Share codes</div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="content-section">
      <div class="section-header">
        <h2 class="section-title">Quick Actions</h2>
      </div>
      <div class="quick-actions">
        <a href="/guards" class="quick-action-btn">
          <span>üë•</span>
          <span>Manage Guards</span>
        </a>
        <a href="/monthly-hours" class="quick-action-btn secondary">
          <span>‚è∞</span>
          <span>Enter Hours</span>
        </a>
        <a href="/payroll" class="quick-action-btn success">
          <span>üí≥</span>
          <span>Process Payroll</span>
        </a>
        <a href="/reports" class="quick-action-btn">
          <span>üìä</span>
          <span>View Reports</span>
        </a>
      </div>
    </div>

    <!-- Alerts Section -->
    <div class="content-section">
      <div class="section-header">
        <h2 class="section-title">Current Shifts Details for <span id="currentDate"></span></h2>
        <div class="section-actions">
          <input type="date" id="shiftsDateFilter" style="padding: 10px 15px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;" onchange="refreshShifts()">
          <button class="btn-secondary" onclick="refreshShifts()">Refresh</button>
        </div>
      </div>
      <div class="table-container">
        <table class="payroll-table">
          <thead>
            <tr>
              <th>Client</th>
              <th>Site</th>
              <th>Post Code</th>
              <th>Date</th>
              <th>Start Time</th>
              <th>End Time</th>
              <th>Hours</th>
              <th>Employee</th>
              <th>Contact</th>
              <th>SIA</th>
              <th>Expiry</th>
              <th>Total Hours Spent</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="shiftsBody">
            <tr>
              <td colspan="13" class="empty-state">Loading shift details...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Alerts Section -->
        <div class="section-actions">
          <button class="btn-secondary" onclick="refreshAlerts()">Refresh</button>
          <button class="btn-secondary" onclick="markAllRead()">Mark All as Read</button>
        </div>
      </div>
      <div id="alertsContainer" class="alerts-grid">
        <div class="loading">
          <div class="spinner"></div>
          Loading alerts...
        </div>
      </div>
    </div>

    <!-- Pending Payroll Section -->
    <div class="content-section">
      <div class="section-header">
        <h2 class="section-title">Pending Payroll Deductions</h2>
        <div class="section-actions">
          <button class="btn-secondary" onclick="refreshPayrolls()">Refresh</button>
        </div>
      </div>
      <div class="table-container">
        <table class="payroll-table" id="payrollTable">
          <thead>
            <tr>
              <th>Guard Name</th>
              <th>Month</th>
              <th>Hours Deducted</th>
              <th>Amount</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="payrollBody">
            <tr>
              <td colspan="6" class="empty-state">Loading...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Summary Section -->
    <div class="content-section">
      <div class="section-header">
        <h2 class="section-title">Monthly Summary</h2>
      </div>
      <div class="stats-row">
        <div class="stat-box">
          <div class="stat-box-label">Guards with Entries</div>
          <div class="stat-box-value" id="guardsWithEntries">0</div>
        </div>
        <div class="stat-box">
          <div class="stat-box-label">Average Hours per Guard</div>
          <div class="stat-box-value"><span id="avgHours">0</span>h</div>
        </div>
        <div class="stat-box">
          <div class="stat-box-label">Highest Hours</div>
          <div class="stat-box-value"><span id="maxHours">0</span>h</div>
        </div>
        <div class="stat-box">
          <div class="stat-box-label">Lowest Hours</div>
          <div class="stat-box-value"><span id="minHours">0</span>h</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      loadDashboardData();
      // Refresh every 30 seconds
      setInterval(loadDashboardData, 30000);
    });

    async function loadDashboardData() {
      try {
        const metricsResponse = await fetch('/api/dashboard-metrics');
        const metricsResult = await metricsResponse.json();

        if (metricsResult.success) {
          const data = metricsResult.data;
          displayMetrics(data);
        }

        // Load alerts
        await refreshAlerts();

        // Load pending payrolls
        await refreshPayrolls();
      } catch (error) {
        console.error('Error loading dashboard:', error);
      }
    }

    function displayMetrics(data) {
      document.getElementById('totalGuards').textContent = data.totalGuards;

      const monthlyStats = data.monthlyStats;
      const totalMinutes = (monthlyStats.totalHours * 60) + monthlyStats.totalMinutes;
      const paidMinutes = (monthlyStats.paidHours * 60) + monthlyStats.paidMinutes;
      const remainingMinutes = (monthlyStats.remainingHours * 60) + monthlyStats.remainingMinutes;

      document.getElementById('totalHoursValue').textContent = monthlyStats.totalHours;
      document.getElementById('totalMinutesValue').textContent = monthlyStats.totalMinutes;

      document.getElementById('paidHoursValue').textContent = monthlyStats.paidHours;
      document.getElementById('paidMinutesValue').textContent = monthlyStats.paidMinutes;

      const remainingHours = Math.floor(remainingMinutes / 60);
      const remainingMins = remainingMinutes % 60;
      document.getElementById('remainingHoursValue').textContent = remainingHours;
      document.getElementById('remainingMinutesValue').textContent = remainingMins;

      document.getElementById('pendingPayrolls').textContent = data.pendingPayrolls;
      document.getElementById('expiringAlerts').textContent = data.expiringAlerts;

      // Calculate total hours added today
      calculateTodaysTotalHours();
    }

    async function calculateTodaysTotalHours() {
      try {
        const response = await fetch('/api/payroll');
        const result = await response.json();

        if (result.success && Array.isArray(result.data)) {
          const today = new Date().toDateString();
          
          let todaysTotalHours = 0;
          let todaysTotalMinutes = 0;

          result.data.forEach(record => {
            const recordDate = new Date(record.createdAt).toDateString();
            if (recordDate === today) {
              todaysTotalHours += record.totalHours || 0;
              todaysTotalMinutes += record.totalMinutes || 0;
            }
          });

          // Convert extra minutes to hours
          todaysTotalHours += Math.floor(todaysTotalMinutes / 60);
          todaysTotalMinutes = todaysTotalMinutes % 60;

          document.getElementById('totalHoursAdded').textContent = todaysTotalHours;
          document.getElementById('totalHoursAddedMinutes').textContent = todaysTotalMinutes;
        }
      } catch (error) {
        console.error('Error calculating today\'s total hours:', error);
      }
    }

    async function refreshAlerts() {
      try {
        const response = await fetch('/api/alerts?isResolved=false');
        const result = await response.json();

        if (result.success) {
          displayAlerts(result.data);
        }
      } catch (error) {
        console.error('Error loading alerts:', error);
      }
    }

    function displayAlerts(alerts) {
      const container = document.getElementById('alertsContainer');

      if (alerts.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>No active alerts. Great job! üéâ</p></div>';
        return;
      }

      const alertsByType = {
        unpaid_hours: [],
        expiring_share_code: [],
        visa_expiry: [],
        missing_hours: [],
        overpayment_risk: []
      };

      alerts.forEach(alert => {
        if (alertsByType[alert.alertType]) {
          alertsByType[alert.alertType].push(alert);
        }
      });

      let html = '';
      alerts.slice(0, 10).forEach(alert => {
        const severityClass = alert.severity.toLowerCase();
        const badgeClass = `badge-${severityClass}`;

        html += `
          <div class="alert-item ${severityClass}">
            <div class="alert-content">
              <div class="alert-title">
                ${alert.title}
                <span class="alert-badge ${badgeClass}">${alert.severity}</span>
              </div>
              <div class="alert-description">${alert.description}</div>
            </div>
            <div class="alert-actions">
              <button class="btn-small" onclick="markAlertRead('${alert._id}')">Mark Read</button>
              <button class="btn-small" onclick="resolveAlert('${alert._id}')">Resolve</button>
            </div>
          </div>
        `;
      });

      if (alerts.length > 10) {
        html += `<div class="empty-state"><p>+${alerts.length - 10} more alerts...</p></div>`;
      }

      container.innerHTML = html;
    }

    async function refreshPayrolls() {
      try {
        const response = await fetch('/api/payroll-deductions?status=pending');
        const result = await response.json();

        if (result.success) {
          displayPendingPayrolls(result.data);
        }
      } catch (error) {
        console.error('Error loading payrolls:', error);
      }
    }

    function displayPendingPayrolls(payrolls) {
      const tbody = document.getElementById('payrollBody');

      if (payrolls.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No pending payrolls</td></tr>';
        return;
      }

      tbody.innerHTML = payrolls.slice(0, 10).map(p => {
        const guardName = p.guardId ? p.guardId.guardName : 'Unknown';
        const monthName = new Date(p.year, p.month - 1).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });

        return `
          <tr>
            <td>${guardName}</td>
            <td>${monthName}</td>
            <td>${p.deductedHours}h ${p.deductedMinutes}m</td>
            <td>¬£${p.paymentAmount.toFixed(2)}</td>
            <td><span class="status-badge status-${p.status}">${p.status}</span></td>
            <td>
              <button class="btn-small" onclick="markAsPaid('${p._id}')">Mark Paid</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    async function markAlertRead(id) {
      try {
        await fetch(`/api/alerts/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ isRead: true })
        });
        refreshAlerts();
      } catch (error) {
        console.error('Error marking alert:', error);
      }
    }

    async function resolveAlert(id) {
      try {
        await fetch(`/api/alerts/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ isResolved: true, resolvedNotes: 'Resolved from dashboard' })
        });
        refreshAlerts();
      } catch (error) {
        console.error('Error resolving alert:', error);
      }
    }

    async function markAllRead() {
      try {
        const response = await fetch('/api/alerts?isResolved=false');
        const result = await response.json();
        
        if (result.success) {
          for (const alert of result.data) {
            await fetch(`/api/alerts/${alert._id}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ isRead: true })
            });
          }
          refreshAlerts();
        }
      } catch (error) {
        console.error('Error:', error);
      }
    }

    async function markAsPaid(id) {
      try {
        const response = await fetch(`/api/payroll-deductions/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: 'paid', paidDate: new Date() })
        });
        const result = await response.json();
        if (result.success) {
          refreshPayrolls();
        }
      } catch (error) {
        console.error('Error:', error);
      }
    }

    // Set current date on page load
    document.addEventListener('DOMContentLoaded', function() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('shiftsDateFilter').value = today;
      document.getElementById('currentDate').textContent = today;
      refreshShifts();
    });

    async function refreshShifts() {
      try {
        const dateFilter = document.getElementById('shiftsDateFilter').value || new Date().toISOString().split('T')[0];
        document.getElementById('currentDate').textContent = dateFilter;
        
        const response = await fetch(`/api/payroll?date=${dateFilter}`);
        const result = await response.json();

        if (result.success) {
          displayShifts(result.data);
        }
      } catch (error) {
        console.error('Error loading shifts:', error);
      }
    }

    function displayShifts(shifts) {
      const tbody = document.getElementById('shiftsBody');
      
      if (!shifts || shifts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="13" class="empty-state">No shifts recorded for this date</td></tr>';
        return;
      }

      tbody.innerHTML = shifts.map(shift => {
        const totalHours = shift.totalHours || 0;
        const totalMinutes = shift.totalMinutes || 0;
        const hoursSpent = totalHours + (totalMinutes / 60);
        
        // Calculate total hours spent by this guard across all payroll records
        const guardTotalHours = shift.totalHours || 0;
        const guardTotalMinutes = shift.totalMinutes || 0;
        const totalHoursSpent = guardTotalHours + (guardTotalMinutes / 60);

        return `
          <tr>
            <td>${shift.clientName || '-'}</td>
            <td>${shift.siteName || '-'}</td>
            <td>${shift.postCode || '-'}</td>
            <td>${shift.createdAt ? new Date(shift.createdAt).toLocaleDateString() : '-'}</td>
            <td>-</td>
            <td>-</td>
            <td>${totalHours}h ${totalMinutes}m</td>
            <td>${shift.guardName || '-'}</td>
            <td>${shift.phoneNumber || '-'}</td>
            <td>${shift.siaLicense && shift.siaLicense.licenseNumber ? shift.siaLicense.licenseNumber : '-'}</td>
            <td>${shift.siaLicense && shift.siaLicense.expiryDate ? new Date(shift.siaLicense.expiryDate).toLocaleDateString() : '-'}</td>
            <td>${totalHoursSpent.toFixed(2)}h</td>
            <td><span class="status-badge status-pending">Pending</span></td>
          </tr>
        `;
      }).join('');
    }
  </script>
</body>
</html>
