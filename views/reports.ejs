<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reports - Payroll System</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="icon" type="image/png" href="/images/salary.png">
  <style>
    .reports-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .reports-header {
      margin-bottom: 30px;
    }

    .reports-header h1 {
      margin: 0 0 10px 0;
      font-size: 2em;
      color: #333;
    }

    .filter-section {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 25px;
      margin-bottom: 30px;
    }

    .filter-section h3 {
      margin-top: 0;
      color: #333;
      font-size: 1.2em;
      margin-bottom: 20px;
    }

    .filter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .form-group select,
    .form-group input {
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }

    .form-group select:focus,
    .form-group input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .column-selector {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 25px;
      margin-bottom: 30px;
    }

    .column-selector h3 {
      margin-top: 0;
      color: #333;
      font-size: 1.2em;
      margin-bottom: 15px;
    }

    .checkbox-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .checkbox-group input[type="checkbox"] {
      width: auto;
      margin: 0;
      cursor: pointer;
    }

    .checkbox-group label {
      margin: 0;
      cursor: pointer;
      font-size: 14px;
    }

    .action-buttons {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .btn-primary,
    .btn-secondary {
      padding: 12px 25px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background-color: #f0f0f0;
      color: #333;
    }

    .btn-secondary:hover {
      background-color: #e0e0e0;
    }

    .btn-export {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
    }

    .btn-export:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
    }

    .table-section {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 25px;
      margin-bottom: 30px;
    }

    .table-section h3 {
      margin-top: 0;
      color: #333;
      font-size: 1.2em;
      margin-bottom: 20px;
    }

    .table-container {
      overflow-x: auto;
      margin-bottom: 20px;
    }

    .report-table {
      width: 100%;
      border-collapse: collapse;
    }

    .report-table th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      text-align: left;
      font-weight: 600;
      white-space: nowrap;
    }

    .report-table td {
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
    }

    .report-table tr:hover {
      background-color: #f9f9f9;
    }

    .report-summary {
      background: linear-gradient(135deg, #f5f5f5 0%, #ffffff 100%);
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #eee;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }

    .summary-row:last-child {
      border-bottom: none;
    }

    .summary-label {
      font-weight: 600;
      color: #333;
    }

    .summary-value {
      font-weight: 600;
      color: #667eea;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #999;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #999;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .report-type-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .report-tab {
      padding: 12px 25px;
      border: 2px solid #ddd;
      background: white;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }

    .report-tab.active {
      border-color: #667eea;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .report-tab:hover {
      border-color: #667eea;
    }

    @media (max-width: 768px) {
      .filter-grid {
        grid-template-columns: 1fr;
      }

      .checkbox-grid {
        grid-template-columns: 1fr;
      }

      .action-buttons {
        flex-direction: column;
      }

      .btn-primary,
      .btn-secondary,
      .btn-export {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- Global Header -->
  <header>
    <div class="container">
      <div class="header-brand">
        <img src="/images/salary.png" alt="Payroll Logo" class="logo">
        <h1>üíº Payroll Pro</h1>
      </div>
      <nav>
        <ul>
          <li><a href="/">üè† Home</a></li>
          <li><a href="/guards">üë• Guards</a></li>
          <li><a href="/clients">üè¢ Clients</a></li>
          <li><a href="/monthly-hours">‚è∞ Monthly Hours</a></li>
          <li><a href="/reports">üìä Reports</a></li>
          <li><a href="/roster">Roster</a></li>
          <li><a href="/upload">üì§ Upload</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <div class="reports-container">
    <!-- Header -->
    <div class="reports-header">
      <h1>Reports</h1>
      <p>Generate and analyze payroll reports with dynamic filters and columns</p>
    </div>

    <!-- Report Type Selection -->
    <div class="report-type-tabs">
      <button class="report-tab active" onclick="switchReportType('guard')">Guard Report</button>
      <button class="report-tab" onclick="switchReportType('client')">Client Report</button>
      <button class="report-tab" onclick="switchReportType('master')">Master Report</button>
    </div>

    <!-- Filter Section -->
    <div class="filter-section">
      <h3>Report Filters</h3>
      
      <div class="filter-grid">
        <div class="form-group">
          <label>Report Month</label>
          <input type="month" id="reportMonth">
        </div>

        <div class="form-group" id="guardFilterGroup" style="display: none;">
          <label>Select Guard</label>
          <select id="guardFilter">
            <option value="">All Guards</option>
          </select>
        </div>

        <div class="form-group" id="clientFilterGroup" style="display: none;">
          <label>Select Client</label>
          <select id="clientFilter">
            <option value="">All Clients</option>
          </select>
        </div>

        <div class="form-group">
          <label>Status</label>
          <select id="statusFilter">
            <option value="">All Status</option>
            <option value="paid">Paid</option>
            <option value="pending">Pending</option>
            <option value="cancelled">Cancelled</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Column Selector -->
    <div class="column-selector">
      <h3>Select Columns</h3>
      <div class="checkbox-grid" id="columnSelector">
        <!-- Generated by JavaScript -->
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
      <button class="btn-primary" onclick="generateReport()">Generate Report</button>
      <button class="btn-export" onclick="exportPDF()">üì• Export as PDF</button>
      <button class="btn-export" onclick="exportExcel()">üì• Export as Excel</button>
      <button class="btn-secondary" onclick="resetFilters()">Reset Filters</button>
    </div>

    <!-- Report Results -->
    <div class="table-section" id="reportSection" style="display: none;">
      <h3 id="reportTitle">Report Results</h3>
      
      <div class="table-container">
        <table class="report-table" id="reportTable">
          <thead id="reportTableHead">
            <!-- Generated by JavaScript -->
          </thead>
          <tbody id="reportTableBody">
            <!-- Generated by JavaScript -->
          </tbody>
        </table>
      </div>

      <div class="report-summary" id="reportSummary">
        <!-- Generated by JavaScript -->
      </div>
    </div>

    <div id="emptyMessage" class="empty-state" style="display: none;">
      <p>Select filters and click "Generate Report" to view results.</p>
    </div>
  </div>

  <script>
    let currentReportType = 'guard';
    let allGuards = [];
    let allClients = new Set();
    let reportData = [];

    const columnOptions = {
      guard: ['Guard Name', 'Nationality', 'Visa Type', 'Hours', 'Paid Hours', 'Remaining Hours', 'Amount', 'Status', 'Payment Date'],
      client: ['Client Name', 'Site Name', 'Total Guards', 'Total Hours', 'Total Amount', 'Hours Paid', 'Hours Remaining', 'Status'],
      master: ['Guard Name', 'Nationality', 'Email', 'Phone', 'Visa Type', 'Share Code', 'SIA License', 'Bank Account', 'Total Hours Paid']
    };

    const columnMap = {
      'Guard Name': 'guardName',
      'Nationality': 'nationality',
      'Visa Type': 'visaType',
      'Email': 'email',
      'Phone': 'phoneNumber',
      'Hours': 'totalHours',
      'Paid Hours': 'paidHours',
      'Remaining Hours': 'remainingHours',
      'Amount': 'amount',
      'Status': 'status',
      'Payment Date': 'paymentDate',
      'Client Name': 'clientName',
      'Site Name': 'siteName',
      'Total Guards': 'totalGuards',
      'Total Amount': 'totalAmount',
      'Total Hours': 'totalHours',
      'Hours Paid': 'paidHours',
      'Hours Remaining': 'remainingHours',
      'Share Code': 'shareCode',
      'SIA License': 'siaLicense',
      'Bank Account': 'bankAccount'
    };

    document.addEventListener('DOMContentLoaded', () => {
      const today = new Date();
      const monthStr = today.toISOString().slice(0, 7);
      const params = new URLSearchParams(window.location.search);
      const monthParam = params.get('month');
      document.getElementById('reportMonth').value = monthParam || monthStr;

      loadGuards();
      initializeColumnSelector();

      if (monthParam) {
        setTimeout(() => generateReport(), 300);
      }
    });

    async function loadGuards() {
      try {
        const response = await fetch('/api/guards?isActive=true');
        const result = await response.json();

        if (result.success) {
          allGuards = result.data;
          allGuards.forEach(g => {
            if (g.clientName) allClients.add(g.clientName);
          });

          // Populate guard filter
          const guardSelect = document.getElementById('guardFilter');
          guardSelect.innerHTML = '<option value="">All Guards</option>' +
            allGuards.map(g => `<option value="${g._id}">${g.guardName}</option>`).join('');

          // Populate client filter
          const clientSelect = document.getElementById('clientFilter');
          clientSelect.innerHTML = '<option value="">All Clients</option>' +
            Array.from(allClients).map(c => `<option value="${c}">${c}</option>`).join('');
        }
      } catch (error) {
        console.error('Error loading guards:', error);
      }
    }

    function switchReportType(type) {
      currentReportType = type;

      // Update active tab
      document.querySelectorAll('.report-tab').forEach(tab => tab.classList.remove('active'));
      event.target.classList.add('active');

      // Show/hide filters
      document.getElementById('guardFilterGroup').style.display = type === 'guard' ? 'block' : 'none';
      document.getElementById('clientFilterGroup').style.display = type === 'client' ? 'block' : 'none';

      // Update column selector
      initializeColumnSelector();

      // Clear report
      document.getElementById('reportSection').style.display = 'none';
      document.getElementById('emptyMessage').style.display = 'block';
    }

    function initializeColumnSelector() {
      const columns = columnOptions[currentReportType] || [];
      const selector = document.getElementById('columnSelector');

      selector.innerHTML = columns.map((col, idx) => `
        <div class="checkbox-group">
          <input type="checkbox" id="col_${idx}" value="${col}" checked>
          <label for="col_${idx}">${col}</label>
        </div>
      `).join('');
    }

    async function generateReport() {
      try {
        const month = document.getElementById('reportMonth').value;
        if (!month) {
          alert('Please select a month');
          return;
        }

        const [year, monthNum] = month.split('-');

        // Get selected columns
        const selectedCols = Array.from(document.querySelectorAll('#columnSelector input:checked'))
          .map(cb => cb.value);

        if (selectedCols.length === 0) {
          alert('Please select at least one column');
          return;
        }

        // Generate appropriate report
        if (currentReportType === 'guard') {
          await generateGuardReport(year, monthNum, selectedCols);
        } else if (currentReportType === 'client') {
          await generateClientReport(year, monthNum, selectedCols);
        } else if (currentReportType === 'master') {
          await generateMasterReport(year, monthNum, selectedCols);
        }
      } catch (error) {
        console.error('Error generating report:', error);
        alert('Error generating report');
      }
    }

    async function generateGuardReport(year, month, columns) {
      try {
        const response = await fetch(`/api/monthly-hours?year=${year}&month=${month}`);
        const result = await response.json();

        if (result.success) {
          const data = result.data;
          displayReport(data, columns, 'Guard Report');
        }
      } catch (error) {
        console.error('Error:', error);
      }
    }

    async function generateClientReport(year, month, columns) {
      try {
        // Aggregate by client
        const response = await fetch(`/api/monthly-hours?year=${year}&month=${month}`);
        const result = await response.json();

        if (result.success) {
          displayReport(result.data, columns, 'Client Report');
        }
      } catch (error) {
        console.error('Error:', error);
      }
    }

    async function generateMasterReport(year, month, columns) {
      try {
        const response = await fetch('/api/guards?isActive=true');
        const result = await response.json();

        if (result.success) {
          displayReport(result.data, columns, 'Master Report');
        }
      } catch (error) {
        console.error('Error:', error);
      }
    }

    function displayReport(data, columns, title) {
      document.getElementById('reportTitle').textContent = title;
      document.getElementById('reportSection').style.display = 'block';
      document.getElementById('emptyMessage').style.display = 'none';

      const thead = document.getElementById('reportTableHead');
      const tbody = document.getElementById('reportTableBody');

      // Create table header
      thead.innerHTML = `<tr>${columns.map(col => `<th>${col}</th>`).join('')}</tr>`;

      // Create table rows
      tbody.innerHTML = data.slice(0, 100).map(item => {
        const row = columns.map(col => {
          const key = columnMap[col];
          let value = item[key] || '';

          if (typeof value === 'object') {
            value = JSON.stringify(value).substring(0, 30) + '...';
          }

          return `<td>${value}</td>`;
        }).join('');

        return `<tr>${row}</tr>`;
      }).join('');

      // Create summary
      const summary = document.getElementById('reportSummary');
      summary.innerHTML = `
        <div class="summary-row">
          <span class="summary-label">Total Records:</span>
          <span class="summary-value">${data.length}</span>
        </div>
        <div class="summary-row">
          <span class="summary-label">Report Generated:</span>
          <span class="summary-value">${new Date().toLocaleString()}</span>
        </div>
      `;
    }

    function exportPDF() {
      alert('PDF export feature coming soon!');
    }

    function exportExcel() {
      alert('Excel export feature coming soon!');
    }

    function resetFilters() {
      document.getElementById('reportMonth').value = new Date().toISOString().slice(0, 7);
      document.getElementById('guardFilter').value = '';
      document.getElementById('clientFilter').value = '';
      document.getElementById('statusFilter').value = '';
      document.getElementById('reportSection').style.display = 'none';
      document.getElementById('emptyMessage').style.display = 'block';
    }
  </script>
</body>
</html>
